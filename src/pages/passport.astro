---
import '../styles/global.css';
---
<!DOCTYPE html>
<html lang="zh-TW" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å„ªè³ªåº—å®¶</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script is:inline src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        /* Map needs explicit height */
        #map {
            /* Height is handled by container now */
            height: 100%;
            z-index: 1;
        }
        /* Visited card styling */
        .shop-card.visited { 
            border: 1px solid #36d399; /* success color */
            background-color: rgba(54, 211, 153, 0.05);
        }
        .shop-card.visited:hover { 
            background-color: rgba(54, 211, 153, 0.1);
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">

<!-- Navbar & Tabs -->
<!-- Navbar & Tabs -->
<div id="main-navbar" class="bg-base-100 shadow-sm">
    <div class="navbar min-h-12 flex-col sm:flex-row gap-2 px-4">
        <div class="flex-none">
            <span class="text-xl font-bold">âœ¨ å„ªè³ªåº—å®¶è­·ç…§</span>
        </div>
        <div class="flex-1 w-full sm:w-auto overflow-x-auto">
            <div role="tablist" class="tabs tabs-bordered justify-start sm:justify-center w-full">
                <a role="tab" class="tab tab-active h-12 whitespace-nowrap" id="tab-passport" onclick="switchTab('passport')">è¸©é»è­·ç…§</a>
                <a role="tab" class="tab h-12 whitespace-nowrap" id="tab-progress" onclick="switchTab('progress')">è¸©é»é€²åº¦</a>
                <a role="tab" class="tab h-12 whitespace-nowrap" id="tab-leaderboard" onclick="switchTab('leaderboard')">æ’è¡Œæ¦œ</a>
            </div>
        </div>
    </div>
</div>

<!-- Full Width Map View -->
<div id="map-container" class="relative w-full h-[50vh] min-h-[350px] z-0">
    <div id="map" class="w-full h-full z-0"></div>
    <button onclick="locateUser()" class="absolute bottom-4 right-4 z-[400] btn btn-circle btn-sm btn-primary shadow-lg" title="å®šä½æˆ‘çš„ä½ç½®">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>
</div>

<!-- Passport View -->
<div id="passport-view" class="max-w-4xl mx-auto p-4">
    <!-- Filter Buttons -->
    <div id="filter-container" class="flex flex-col sm:flex-row gap-4 mb-4">
        <!-- Location Filter -->
        <select id="location-filter" class="select select-sm select-bordered w-full sm:w-auto min-w-[120px]" onchange="setLocationFilter(this.value)">
            <option value="all">å…¨å°ç£</option>
        </select>
        
        <!-- Category Filters -->
        <div id="filter-categories" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide flex-1">
        </div>
    </div>



    <!-- Loading -->
    <div id="loading" class="text-center py-8 text-base-content/60">
        <span class="loading loading-spinner loading-md"></span>
        <p class="mt-2">è®€å–åº—å®¶è³‡æ–™ä¸­...</p>
    </div>

    <!-- Shop Grid -->
    <div id="shop-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>
</div>

<!-- Progress View -->
<div id="progress-view" class="hidden max-w-4xl mx-auto p-4">
    <div class="card bg-base-100 shadow-sm cursor-pointer hover:shadow-md transition-shadow" onclick="showVisited()" title="é»æ“ŠæŸ¥çœ‹å·²å»éçš„åº—å®¶">
        <div class="card-body p-4">
            <div class="flex justify-between items-center text-sm">
                <span id="progress-text" class="font-medium">è¸©é»é€²åº¦ï¼š0 / 0</span>
                <span id="level-text" class="badge badge-warning">æ–°æ‰‹ä¸Šè·¯</span>
            </div>
            <progress id="progress-fill" class="progress progress-success w-full" value="0" max="100"></progress>
        </div>
    </div>
    
    <div class="mt-6">
        <h3 class="font-bold text-lg mb-4">âœ¨ æ¨è–¦çµ¦ä½ </h3>
        <div id="recommendation-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <!-- Recommendations will be rendered here -->
        </div>
    </div>

    <div class="mt-8">
        <h3 class="font-bold text-lg mb-4">ğŸ† æˆå°±ç³»çµ±</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <!-- Badges placeholders or future content -->
             <div class="card bg-base-100 shadow-sm">
                <div class="card-body p-4">
                    <h4 class="font-bold text-sm">æ–°æ‰‹ä¸Šè·¯</h4>
                    <p class="text-xs text-base-content/60">é–‹å§‹ä½ çš„ç¬¬ä¸€æ¬¡è¸©é»</p>
                </div>
            </div>
             <div class="card bg-base-100 shadow-sm opacity-50">
                <div class="card-body p-4">
                    <h4 class="font-bold text-sm">Coming Soon...</h4>
                    <p class="text-xs text-base-content/60">æ›´å¤šæˆå°±è§£é–ä¸­</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaderboard View -->
<div id="leaderboard-view" class="hidden max-w-4xl mx-auto p-4">
    <div class="text-center py-4">
        <h3 class="text-xl font-bold">ğŸ† å°ç£åˆ¶éœ¸æ’è¡Œæ¦œ</h3>
        <p id="user-rank-info" class="text-base-content/60 mt-2">è¼‰å…¥ä¸­...</p>
    </div>

    <h4 class="font-bold mt-6 mb-3">ğŸ‘¤ ç©å®¶æ’è¡Œæ¦œ</h4>
    <div class="overflow-x-auto">
        <table class="table table-zebra bg-base-100 rounded-lg">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>åç¨±</th>
                    <th>è¸©é»æ•¸</th>
                    <th>ç¨±è™Ÿ</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
            </tbody>
        </table>
    </div>

    <h4 class="font-bold mt-8 mb-3">ğŸ”¥ ç†±é–€åº—å®¶æ’è¡Œæ¦œ</h4>
    <div class="overflow-x-auto">
        <table class="table table-zebra bg-base-100 rounded-lg">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>åº—å®¶åç¨±</th>
                    <th>é¡åˆ¥</th>
                    <th>äººæ°£æŒ‡æ•¸</th>
                </tr>
            </thead>
            <tbody id="shop-leaderboard-body">
            </tbody>
        </table>
    </div>

    <h4 class="font-bold mt-8 mb-3">ğŸ‘€ å…¨å°åº—å®¶æ¡é»å¤§æ¯”æ‹¼</h4>
    <div class="overflow-x-auto">
        <table class="table table-zebra bg-base-100 rounded-lg">
            <thead>
                <tr>
                    <th>åº—å®¶</th>
                    <th>é¡åˆ¥</th>
                    <th>æˆ‘çš„ç‹€æ…‹</th>
                    <th>èª°ä¹Ÿå»é</th>
                </tr>
            </thead>
            <tbody id="comparison-body">
            </tbody>
        </table>
    </div>

    <div class="text-center mt-6">
        <button class="btn btn-outline btn-sm" onclick="updateUserName()">ä¿®æ”¹æˆ‘çš„æš±ç¨±</button>
    </div>
</div>

<!-- Footer -->
<footer class="footer footer-center p-6 bg-base-100 text-base-content/60 mt-8 border-t border-base-300">
    <div>
        <p>è³‡æ–™ä¾†æºï¼šç¤¾ç¾¤å…±ç·¨ | ç³»çµ±è£½ä½œï¼šGemini å”åŠ©é–‹ç™¼</p>
        <div class="flex gap-4 mt-2">
            <a href="https://github.com/bangyuwen/byw-twproduct/issues/new?template=shop_update.md" target="_blank" class="link link-hover">æäº¤è®Šæ›´</a>
            <button class="link link-hover" onclick="exportData()">åŒ¯å‡ºç´€éŒ„</button>
            <button class="link link-hover" onclick="importData()">åŒ¯å…¥ç´€éŒ„</button>
            <button class="link link-hover text-error" onclick="resetData()">é‡ç½®</button>
        </div>
    </div>
</footer>

<script>
    import { fetchAllShops } from "../utils/api";
    import { getRecommendations, preprocessPlaces, type ProcessedPlace, type RecommendedPlace, type SimilarShop } from "../utils/recommendations";
    import { MapRenderer, type MapBounds } from "../utils/mapRenderer";
    import {
        getVisitedShops,
        addVisitedShop,
        removeVisitedShop,
        saveVisitedShops,
        getFavoriteShops,
        toggleFavoriteShop,
        getUserName,
        saveUserName,
        initUserName,
        resetAllData
    } from "../utils/storage";



    // Extend Window interface for custom global functions
    declare global {
        interface Window {
            setFilter: (category: string, btnElement:  HTMLElement | null) => void;
            showVisited: () => void;
            toggleFavorite: (id: string, btn: HTMLButtonElement) => void;
            toggleVisit: (id: string) => void;
            switchTab: (tabName: string) => void;
            toggleMap: (show: boolean) => void;
            updateUserName: () => void;
            setLocationFilter: (location: string) => void;
            exportData: () => void;
            importData: () => void;
            resetData: () => void;
            locateUser: () => void;
            panToShop: (lat: number | string, lng: number | string, id?: string) => void;
        }
    }

    // Local interface including UI-specific properties
    interface LocalShop extends ProcessedPlace {
        id: string;
        map_url: string;
        popularity: number;
        cfScore?: number;        // Optional for recommended shops
        similarTo?: SimilarShop[];       // Optional for recommended shops
        source?: string;
    }

    interface LeaderboardEntry {
        rank: number;
        name: string;
        visited_count: number;
        title: string;
        isUser?: boolean;
    }

    let allShops: LocalShop[] = [];
    let collectionTitle = ''; // æ”¶è—ä¾†æºåç¨±
    let visitedShops: string[] = getVisitedShops();
    let favoriteShops: string[] = getFavoriteShops();
    let userName = getUserName();
    let currentFilter = 'all';
    let currentLocationFilter = 'all';
    let mapRenderer: MapRenderer | null = null;
    let leaderboardData: LeaderboardEntry[] = [];
    let currentBounds: MapBounds | null = null;
    let selectedShopId: string | null = null;

    document.addEventListener('DOMContentLoaded', () => {
        initUserName();
        // Sync local variable just in case, though getUserName() already handled it
        userName = getUserName(); 
        fetchData();

        userName = getUserName(); 
        fetchData();
    });

    // ... (fetchData remains mostly unchanged, just variables) ...

    async function fetchData() {
        try {
            // Fetch data directly
            const data = await fetchAllShops();

            if (!data.places || data.places.length === 0) {
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.innerHTML = '<div class="alert alert-warning"><span>âš ï¸ è¼‰å…¥æˆåŠŸä½†æ²’æœ‰è³‡æ–™</span></div>';
                return;
            }

            // å„²å­˜æ”¶è—ä¾†æºåç¨±
            collectionTitle = data.title || '';

            // Pre-process data (parse strings to sets once)
            const processedPlaces = preprocessPlaces(data.places);

            // Map to local shop format while keeping ProcessedPlace properties
            allShops = processedPlaces.map(place => {
                let cat = place.category;
                // Normalize categories from island.json to match existing gluttony conventions
                if (cat === 'å’–å•¡å»³') cat = 'å’–å•¡';
                if (cat === 'Tea' || cat === 'é£²æ–™åº—') cat = 'é£²æ–™';
                if (cat === 'Bar' || cat === 'é¤é…’é¤¨' || cat === 'å±…é…’å±‹') cat = 'é…’å§';

                return {
                    ...place, // Includes place_id, recent_visitors, visitorSet, visitorCount
                    category: cat, // Use normalized category
                    id: place.place_id, // Adapter for local UI use
                    map_url: place.url, // Adapter for local UI use
                    popularity: place.visitorCount, // Use pre-calculated count
                    source: place.source
                };
            });

            if (allShops.length === 0) {
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.innerHTML = '<div class="alert alert-warning"><span>âš ï¸ è³‡æ–™æ ¼å¼ä¸ç¬¦</span></div>';
                return;
            }

            const loadingEl = document.getElementById('loading');
            if (loadingEl) loadingEl.style.display = 'none';

            initMap();
            renderFilters();
            renderShops();
            updateProgress();
            fetchLeaderboard();
        } catch (err) {
            console.error(err);
            const errorMessage = err instanceof Error ? err.message : 'æœªçŸ¥éŒ¯èª¤';
            const loadingEl = document.getElementById('loading');
            if (loadingEl) loadingEl.innerHTML = `<div class="alert alert-error"><span>âŒ è¼‰å…¥å¤±æ•—: ${errorMessage}</span></div>`;
        }
    }

    function renderFilters() {
        // Extract unique locations
        const locations = new Set<string>();
        allShops.forEach(s => {
            if (s.county) locations.add(s.county);
            if (s.city) locations.add(s.city);
        });
        const sortedLocations = Array.from(locations).sort();

        // Render Location Select
        const locationSelect = document.getElementById('location-filter');
        if (locationSelect) {
            let options = '<option value="all">å…¨å°ç£</option>';
            sortedLocations.forEach(loc => {
                options += `<option value="${loc}" ${currentLocationFilter === loc ? 'selected' : ''}>${loc}</option>`;
            });
            locationSelect.innerHTML = options;
        }

        // Render Category Buttons
        // Remove 'æ¨è–¦' from the main filter list
        const categories = ['å…¨éƒ¨', 'ç†±é–€', ...new Set(allShops.map(s => s.category))];
        const container = document.getElementById('filter-categories');
        if (!container) return; // Null check

        let html = '';
        categories.forEach(cat => {
            let label = cat;
            let val = cat;

            if (cat === 'å…¨éƒ¨') {
                val = 'all';
            } else if (cat === 'ç†±é–€') {
                val = 'hot';
                label = 'ğŸ”¥ ç†±é–€';
            }

            html += `<button class="btn btn-sm ${val === currentFilter ? 'btn-primary' : 'btn-ghost'} whitespace-nowrap"
                             onclick="setFilter('${val}', this)">${label}</button>`;
        });
        container.innerHTML = html;
    }

    window.setLocationFilter = function(location: string) {
        currentLocationFilter = location;
        
        // We need to re-run filtering logic similar to renderShops but we want the result to use for map.
        // Actually renderShops calls getFilteredShops internally.
        // But we want to call updateMapMarkers with the NEW filtered list. 
        // And we want to bounds check on THAT list.
        
        // Let's refactor slightly: 
        // 1. Get filtered shops 
        const filtered = getFilteredShops(currentFilter, allShops, visitedShops, null, null, currentLocationFilter);
        
        // 2. Render list
        renderShops(); // renderShops recalculates filtered internally if we don't pass it. 
                       // Wait, renderShops implementation (lines 394+) likely calls getFilteredShops? 
                       // Let's check view_file 360-400. Yes line 399/400 suggests it rebuilds list or we should pass it.
                       // Looking at current implementation of renderShops (not fully visible but implied), it likely gets filtered shops itself.
                       // However, updateMapMarkers ALSO likely gets filtered shops itself or expects them.
                       
        // To be SAFE and efficient, let's look at `renderShops` signature or logic. 
        // Actually, let's just use `filtered` for map syncing since that's independent of rendering.
        
        renderShops();
        updateMapMarkers();
        
        // Sync map with location filter
        if (mapRenderer) {
            if (location === 'all') {
                // Reset to default Taiwan view
                 mapRenderer.setView([23.97565, 120.9738819], 7);
            } else {
                // Find bounds of filtered shops
                let minLat = 90, maxLat = -90, minLng = 180, maxLng = -180;
                let hasValidCoords = false;

                filtered.forEach(shop => {
                     const lat = typeof shop.lat === 'string' ? parseFloat(shop.lat) : shop.lat;
                     const lng = typeof shop.lng === 'string' ? parseFloat(shop.lng) : shop.lng;
                     
                     if (!isNaN(lat) && !isNaN(lng)) {
                         minLat = Math.min(minLat, lat);
                         maxLat = Math.max(maxLat, lat);
                         minLng = Math.min(minLng, lng);
                         maxLng = Math.max(maxLng, lng);
                         hasValidCoords = true;
                     }
                });

                if (hasValidCoords) {
                    // Add some padding
                    const latPad = (maxLat - minLat) * 0.1;
                    const lngPad = (maxLng - minLng) * 0.1;
                    // Ensure we don't zoom in too much for single points by adding min buffer
                    if (latPad === 0) {
                         mapRenderer.setView([minLat, minLng], 13);
                    } else {
                         mapRenderer.fitBounds([
                             [minLat - latPad, minLng - lngPad], 
                             [maxLat + latPad, maxLng + lngPad]
                         ]);
                    }
                }
            }
        }
    }

    window.setFilter = function(category: string, btnElement: HTMLElement | null) {
        currentFilter = category;
        selectedShopId = null; // Reset selection on filter change
        document.querySelectorAll('#filter-categories .btn').forEach(b => {
             b.classList.remove('btn-primary');
             b.classList.add('btn-ghost');
        });
        
        if (btnElement) {
            btnElement.classList.remove('btn-ghost');
            btnElement.classList.add('btn-primary');
        }
        renderShops();
        updateMapMarkers();
    }

    window.showVisited = function() {
        window.switchTab('passport');
        window.setFilter('visited', null);
    }

    function renderShops() {
        const container = document.getElementById('shop-list');
        if (!container) return; // Null check
        container.innerHTML = '';

        let filtered: LocalShop[] = []; // Explicit type
        let isRecommend = false;

        if (currentFilter === 'all') {
            // Get center for sorting by distance
            const center = mapRenderer ? mapRenderer.getCenter() : null;
            filtered = getFilteredShops('all', allShops, visitedShops, currentBounds, center, currentLocationFilter);
        } else {
            filtered = getFilteredShops(currentFilter, allShops, visitedShops, currentBounds, null, currentLocationFilter);
            if (currentFilter === 'recommend') isRecommend = true;
        }

        // Reorder if a shop is selected
        if (selectedShopId) {
            const idx = filtered.findIndex(s => s.id === selectedShopId);
            if (idx > -1) {
                const [shop] = filtered.splice(idx, 1);
                filtered.unshift(shop);
            } else {
                // If not in the current filtered list (e.g. not recommended), find in allShops
                const shop = allShops.find(s => s.id === selectedShopId);
                if (shop) {
                    filtered.unshift(shop);
                }
            }
        }

        if(filtered.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center py-8 text-base-content/60">æ²’æœ‰ç¬¦åˆçš„åº—å®¶</div>';
            return;
        }

        // Show recommendation explanation
        if (isRecommend) {
            const explainDiv = document.createElement('div');
            explainDiv.className = 'col-span-full mb-4 p-3 bg-primary/10 rounded-lg text-sm text-center';
            explainDiv.innerHTML = visitedShops.length > 0
                ? 'ğŸ¤ æ ¹æ“šç›¸ä¼¼ç©å®¶ + ç›¸ä¼¼åº—å®¶æ¨è–¦ï¼ˆHybrid CFï¼‰'
                : 'ğŸŒŸ ä½ é‚„æ²’è¸©é»ï¼Œå…ˆæ¨è–¦ç†±é–€åº—å®¶çµ¦ä½ ';
            container.appendChild(explainDiv);
        }

        filtered.forEach(shop => {
            const isVisited = visitedShops.includes(shop.id);
            const isFavorite = favoriteShops.includes(shop.id);
            const popularity = shop.popularity || 0;
            const isHot = popularity >= 800;
            const isClosed = shop.permanently_closed; // Check closed status

            const card = document.createElement('div');
            card.className = `card bg-base-100 shadow-sm hover:shadow-md transition-shadow shop-card cursor-pointer ${isVisited ? 'visited' : ''} ${isClosed ? 'grayscale opacity-70' : ''}`;

            // Category icons
            let visualIcon = 'ğŸ‡¹ğŸ‡¼';
            if (shop.category === 'ç¾é£Ÿ') visualIcon = 'ğŸœ';
            else if (shop.category === 'å’–å•¡') visualIcon = 'â˜•';
            else if (shop.category === 'ç”œé»') visualIcon = 'ğŸ°';
            else if (shop.category === 'å†°å“') visualIcon = 'ğŸ§';
            else if (shop.category === 'é£²æ–™') visualIcon = 'ğŸ¥¤';
            else if (shop.category === 'é…’å§') visualIcon = 'ğŸº';
            else if (shop.category === 'æ™¯é»') visualIcon = 'â›©ï¸';
            else if (shop.category === 'æ›¸åº—') visualIcon = 'ğŸ“š';
            else if (shop.category === 'è—æ–‡') visualIcon = 'ğŸ¨';
            else if (shop.category === 'ç”Ÿæ´»') visualIcon = 'ğŸ ';
            else if (shop.category === 'ä½å®¿') visualIcon = 'ğŸ¨';
            else if (shop.category === 'å¯µç‰©') visualIcon = 'ğŸ¾';
            else if (shop.category === 'ç¾å®¹') visualIcon = 'ğŸ’‡';
            else if (shop.category === 'è³¼ç‰©') visualIcon = 'ğŸ›ï¸';
            else if (shop.category === 'é†«ç™‚') visualIcon = 'ğŸ¥';
            else if (shop.category === 'é‹å‹•') visualIcon = 'ğŸ’ª';
            else if (shop.category === 'å…¶ä»–') visualIcon = 'âœ¨';

            const visitors = shop.visitors || [];
            const visitorsHtml = visitors.length > 0
                ? `<div class="flex flex-wrap gap-1 mt-2">
                    <span class="text-xs text-base-content/50">å»éï¼š</span>
                    ${visitors.slice(0, 3).map(v => `<span class="badge badge-ghost badge-xs">${v}</span>`).join('')}
                    ${visitors.length > 3 ? `<span class="text-xs text-base-content/50">+${visitors.length - 3}</span>` : ''}
                   </div>`
                : '';

            // Item-to-Item: show which visited shops are similar
            // Social Counts
            const visitCount = visitors.length;
            const collectCount = shop.popularity || 0;
            
            const statsHtml = `
                <div class="flex gap-3 text-xs text-base-content/60 mt-2 mb-1">
                    <span class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                        </svg>
                        ${collectCount} äººæ”¶è—
                    </span>
                    <span class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                        ${visitCount} äººå»é
                    </span>
                </div>
            `;

            const similarToHtml = (isRecommend && shop.similarTo && shop.similarTo.length > 0)
                ? `<div class="text-xs text-primary mt-1">
                    ğŸ”— å› ç‚ºä½ å»éï¼š${shop.similarTo.slice(0, 2).map(s => s.visitedName).join('ã€')}
                   </div>`
                : '';

            const showRecommendBadge = isRecommend && shop.cfScore;

            card.innerHTML = `
                <div class="card-body p-4 relative">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">${visualIcon}</span>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-base leading-tight">
                                ${shop.name}
                                ${isHot ? '<span class="text-warning text-sm">ğŸ”¥</span>' : ''}
                                ${showRecommendBadge ? '<span class="badge badge-primary badge-xs ml-1">æ¨è–¦</span>' : ''}
                                ${isClosed ? '<span class="badge badge-neutral badge-xs ml-1">æ°¸ä¹…æ­‡æ¥­</span>' : ''}
                            </h3>
                            <span class="text-xs text-base-content/50">${shop.category} Â· ${shop.source || collectionTitle}</span>
                        </div>
                    </div>
                    <p class="text-sm text-base-content/60 line-clamp-2 mt-2">${shop.description || 'æš«ç„¡ä»‹ç´¹'}</p>
                    ${statsHtml}
                    ${similarToHtml}
                    ${visitorsHtml}
                    <div class="card-actions justify-between items-center mt-auto pt-3 border-t border-base-200">
                        <div class="flex gap-1">
                            <a href="${shop.map_url}" target="_blank" class="btn btn-xs btn-ghost" title="åœ°åœ–">ğŸ“</a>
                            <button class="btn btn-xs ${isFavorite ? 'btn-error text-white' : 'btn-ghost text-error'}"
                                    onclick="toggleFavorite('${shop.id}', this)" title="æ”¶è—">
                                ${isFavorite ? 'â¤' : 'â™¡'}
                            </button>
                        </div>
                        <button class="btn btn-xs ${isVisited ? 'btn-success' : 'btn-outline'}"
                                onclick="toggleVisit('${shop.id}')">
                            ${isVisited ? 'å·²æ”»ç•¥' : 'æ”»ç•¥'}
                        </button>
                    </div>
                </div>
            `;
            // Attach click event for panning
            card.addEventListener('click', (e) => {
                const target = e.target as HTMLElement;
                // Avoid triggering when clicking buttons or links
                if (target.closest('button') || target.closest('a')) return;
                window.panToShop(shop.lat, shop.lng, shop.id);
            });

            container.appendChild(card);
        });
    }

    window.toggleFavorite = function(id: string, btn: HTMLButtonElement) {
        favoriteShops = toggleFavoriteShop(id);
        
        // Optimistic UI update instead of full re-render for better UX
        const isFav = favoriteShops.includes(id);
        btn.classList.toggle('btn-error', isFav);
        btn.classList.toggle('text-white', isFav);
        btn.classList.toggle('btn-ghost', !isFav);
        btn.innerText = isFav ? 'â¤' : 'â™¡';
    }

    window.toggleVisit = function(id: string) {
        if (visitedShops.includes(id)) {
            visitedShops = removeVisitedShop(id);
        } else {
            visitedShops = addVisitedShop(id);
        }
        renderShops();
        updateMapMarkers();
        updateProgress();
    }

    // New function to pan map
    window.panToShop = function(lat: number | string, lng: number | string, id?: string) {
        const latNum = typeof lat === 'string' ? parseFloat(lat) : lat;
        const lngNum = typeof lng === 'string' ? parseFloat(lng) : lng;

        if (mapRenderer && !isNaN(latNum) && !isNaN(lngNum)) {
             mapRenderer.setView([latNum, lngNum], 16);
             if (id) {
                 // Slight delay to ensure view set finishes or just for better UX
                 setTimeout(() => {
                    if (mapRenderer) mapRenderer.openPopup(id);
                 }, 300);
             }
             // Always show passport view when sorting/panning
             window.switchTab('passport');
             // Scroll to map for better UX, center it
             document.getElementById('map')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function updateProgress() {
        const total = allShops.length;
        const current = visitedShops.length;
        const percent = total === 0 ? 0 : Math.round((current / total) * 100);

        const { title, badgeClass } = getRankTitle(current, total);

        document.getElementById('progress-text')!.innerText = `è¸©é»é€²åº¦ï¼š${current} / ${total}`;
        const progressFill = document.getElementById('progress-fill') as HTMLProgressElement;
        if (progressFill) progressFill.value = percent;

        const levelEl = document.getElementById('level-text');
        if (levelEl) {
            levelEl.innerText = title;
            levelEl.className = `badge ${badgeClass}`;
        }
        
        // Update recommendations when progress (visited shops) changes
        renderRecommendations();
    }

    // Toggle map visibility based on tab
    window.toggleMap = function(show: boolean) {
        const mapContainer = document.getElementById('map-container');
        if(mapContainer) {
            mapContainer.style.display = show ? 'block' : 'none';
            if (show && mapRenderer) {
                mapRenderer.invalidateSize();
            }
        }
    }

    // Override switchTab to handle map visibility
    const originalSwitchTab = window.switchTab; // We don't have this, it's defined in inline onclick mostly or valid in global scope??
    // Actually we need to implement switchTab logic since it was likely inline or global somewhere not visible in snippet?
    // Wait, the previous code had `switchTab` declared in Window but not implemented in the snippet provided in view_file 130... 
    // Ah, it WAS NOT IMPLEMENTED in the previous snippet I viewed (lines 1-800).
    // It must be further down or I missed it.
    // I will check lines 800+ before assuming. 
    // BUT, I can see `onclick="switchTab('passport')"` in HTML.
    // I should implement or locate it.
    // Let me wrap it to be safe or define it if missing.
    
    // START CHECK: Previous view stopped at 800. Let's assume it's there. 
    // I'll define it here to be safe and override behavior.
    
    window.switchTab = function(tabName: string) {
        // Hide all views
        document.getElementById('passport-view')?.classList.add('hidden');
        document.getElementById('progress-view')?.classList.add('hidden');
        document.getElementById('leaderboard-view')?.classList.add('hidden');
        
        // Remove active class from tabs
        document.getElementById('tab-passport')?.classList.remove('tab-active');
        document.getElementById('tab-progress')?.classList.remove('tab-active');
        document.getElementById('tab-leaderboard')?.classList.remove('tab-active');
        
        // Show target view
        document.getElementById(`${tabName}-view`)?.classList.remove('hidden');
        document.getElementById(`tab-${tabName}`)?.classList.add('tab-active');
        
        // Handle Map Visibility
        if (tabName === 'passport') {
            window.toggleMap(true);
        } else {
            window.toggleMap(false);
        }
    }

    function renderRecommendations() {
        const container = document.getElementById('recommendation-list');
        if (!container) return;
        
        // Get recommendations using the same logic
        const recommendations = getFilteredShops('recommend', allShops, visitedShops, null);
        
        if (recommendations.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center py-4 text-base-content/60 text-sm">æš«ç„¡æ¨è–¦ï¼Œå¤šå»å¹¾å®¶åº—è©¦è©¦ï¼</div>';
            return;
        }

        container.innerHTML = '';
        // Show top 4 recommendations to avoid clutter
        recommendations.slice(0, 4).forEach(shop => {
            const isVisited = visitedShops.includes(shop.id);
            const isFavorite = favoriteShops.includes(shop.id);
            const isHot = (shop.popularity || 0) >= 800;

            const card = document.createElement('div');
            card.className = `card bg-base-100 shadow-sm hover:shadow-md transition-shadow shop-card cursor-pointer border border-primary/20`;

            // Category icons
            let visualIcon = 'ğŸ‡¹ğŸ‡¼';
            if (shop.category === 'ç¾é£Ÿ') visualIcon = 'ğŸœ';
            else if (shop.category === 'å’–å•¡') visualIcon = 'â˜•';
            else if (shop.category === 'ç”œé»') visualIcon = 'ğŸ°';
            else if (shop.category === 'å†°å“') visualIcon = 'ğŸ§';
            else if (shop.category === 'é£²æ–™') visualIcon = 'ğŸ¥¤';
            else if (shop.category === 'é…’å§') visualIcon = 'ğŸº';
            else if (shop.category === 'æ™¯é»') visualIcon = 'â›©ï¸';
            else if (shop.category === 'æ›¸åº—') visualIcon = 'ğŸ“š';
            else if (shop.category === 'è—æ–‡') visualIcon = 'ğŸ¨';
            else if (shop.category === 'ç”Ÿæ´»') visualIcon = 'ğŸ ';
            else if (shop.category === 'ä½å®¿') visualIcon = 'ğŸ¨';
            else if (shop.category === 'å¯µç‰©') visualIcon = 'ğŸ¾';
            else if (shop.category === 'ç¾å®¹') visualIcon = 'ğŸ’‡';
            else if (shop.category === 'è³¼ç‰©') visualIcon = 'ğŸ›ï¸';
            else if (shop.category === 'é†«ç™‚') visualIcon = 'ğŸ¥';
            else if (shop.category === 'é‹å‹•') visualIcon = 'ğŸ’ª';

            const similarToHtml = (shop.similarTo && shop.similarTo.length > 0)
                ? `<div class="text-xs text-primary mt-1">
                    ğŸ”— å› ç‚ºä½ å»éï¼š${shop.similarTo.slice(0, 2).map(s => s.visitedName).join('ã€')}
                   </div>`
                : '';

            card.innerHTML = `
                <div class="card-body p-4 relative">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">${visualIcon}</span>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-base leading-tight">
                                ${shop.name}
                                ${isHot ? '<span class="text-warning text-sm">ğŸ”¥</span>' : ''}
                            </h3>
                            <span class="text-xs text-base-content/50">${shop.category}</span>
                        </div>
                    </div>
                    ${similarToHtml}
                    <div class="card-actions justify-end items-center mt-2 pt-2 border-t border-base-200">
                         <button class="btn btn-xs btn-primary btn-outline"
                                onclick="panToShop('${shop.lat}', '${shop.lng}', '${shop.id}')">
                            åœ¨åœ°åœ–ä¸ŠæŸ¥çœ‹
                        </button>
                    </div>
                </div>
            `;
            // Attach click event for panning (and switching to passport tab)
            card.addEventListener('click', (e) => {
                const target = e.target as HTMLElement;
                if (target.closest('button') || target.closest('a')) return;
                window.panToShop(shop.lat, shop.lng, shop.id);
            });

            container.appendChild(card);
        });
    }

    function getRankTitle(visitedCount: number, totalCount: number) {
        if (totalCount === 0) return { title: 'æ–°æ‰‹ä¸Šè·¯', badgeClass: 'badge-warning' };
        
        const percent = Math.round((visitedCount / totalCount) * 100);
        
        if (percent === 100) return { title: 'åˆ¶éœ¸å…¨å°ï¼', badgeClass: 'badge-success' };
        if (percent > 80) return { title: 'å°ç£å®ˆè­·ç¥', badgeClass: 'badge-secondary' };
        if (percent > 50) return { title: 'å°æ´¾ä¸­å …', badgeClass: 'badge-primary' };
        if (percent > 20) return { title: 'ç†±å¿ƒåƒèˆ‡è€…', badgeClass: 'badge-info' };
        
        return { title: 'æ–°æ‰‹ä¸Šè·¯', badgeClass: 'badge-warning' };
    }

    function getFilteredShops(filterType: string, shops: LocalShop[], visitedIds: string[], bounds: MapBounds | null = null, center: [number, number] | null = null, locationFilter: string = 'all'): LocalShop[] {
        let result: LocalShop[] = [];
        if (filterType === 'all') {
            result = [...shops]; // Copy array to avoid mutating original
            
            // Sort by distance if center is available
            if (center) {
                const [centerLat, centerLng] = center;
                result.sort((a, b) => {
                    const latA = typeof a.lat === 'number' ? a.lat : parseFloat(a.lat as string);
                    const lngA = typeof a.lng === 'number' ? a.lng : parseFloat(a.lng as string);
                    const latB = typeof b.lat === 'number' ? b.lat : parseFloat(b.lat as string);
                    const lngB = typeof b.lng === 'number' ? b.lng : parseFloat(b.lng as string);
                    
                    if (isNaN(latA) || isNaN(lngA)) return 1;
                    if (isNaN(latB) || isNaN(lngB)) return -1;
                    
                    const distA = Math.pow(latA - centerLat, 2) + Math.pow(lngA - centerLng, 2);
                    const distB = Math.pow(latB - centerLat, 2) + Math.pow(lngB - centerLng, 2);
                    
                    return distA - distB;
                });
            }
        } else if (filterType === 'recommend') {
            const places = getRecommendations(shops as ProcessedPlace[], visitedIds);
            
            // Map returns (LocalShop | null)[]
            const mapped: (LocalShop | null)[] = places.map((s): LocalShop | null => {
                 // Determine if s is RecommendedPlace to access cfScore/similarTo
                 const rec = s as RecommendedPlace;
                 const existing = shops.find(shop => shop.place_id === s.place_id);
                 if (!existing) return null;
                 
                 return {
                    ...existing,
                    cfScore: rec.cfScore,
                    similarTo: rec.similarTo
                 };
            });
            
            result = mapped.filter((s): s is LocalShop => s !== null);

        } else if (filterType === 'hot') {
            result = shops.filter(s => s.popularity >= 800);
            result.sort((a, b) => b.popularity - a.popularity);
        } else if (filterType === 'visited') {
            result = shops.filter(s => visitedIds.includes(s.id));
        } else {
            result = shops.filter(s => s.category === filterType);
        }

        // Apply Location Filter
        if (locationFilter && locationFilter !== 'all') {
            result = result.filter(s => s.county === locationFilter || s.city === locationFilter);
        }

        if (bounds) {
            result = result.filter(s => {
                const lat = typeof s.lat === 'number' ? s.lat : parseFloat(s.lat as string);
                const lng = typeof s.lng === 'number' ? s.lng : parseFloat(s.lng as string);
                if (isNaN(lat) || isNaN(lng)) return false;
                return lat <= bounds.north &&
                       lat >= bounds.south &&
                       lng <= bounds.east &&
                       lng >= bounds.west;
            });
        }

        return result;
    }

    function initMap() {
        if (mapRenderer) return;
        mapRenderer = new MapRenderer('map');
        mapRenderer.init([23.97565, 120.9738819], 7);
        // Initialize bounds immediately
        currentBounds = mapRenderer.getBounds();

        // Ensure proper sizing after init
        setTimeout(() => mapRenderer?.invalidateSize(), 100);

        mapRenderer.onMoveEnd((bounds) => {
            currentBounds = bounds;
            renderShops();
            updateMapMarkers();
        });

        mapRenderer.onShopFocus((id) => {
            selectedShopId = id;
            renderShops();
        });

        updateMapMarkers();
    }

    function updateMapMarkers() {
        if (!mapRenderer) return;
        
        // Pass null for bounds to keep all markers visible on the map
        const filtered = getFilteredShops(currentFilter, allShops, visitedShops, null, null, currentLocationFilter);
        mapRenderer.updateMarkers(filtered, visitedShops);
    }

    function fetchLeaderboard() {
        // Leaderboard data starts empty, will be populated as users interact
        leaderboardData = [];
        renderLeaderboard();
    }

    function renderLeaderboard() {
        const tbody = document.getElementById('leaderboard-body');
        if (!tbody) return;
        tbody.innerHTML = '';

        let currentUser = {
            rank: 0,
            name: userName + ' (æˆ‘)',
            visited_count: visitedShops.length,
            title: document.getElementById('level-text')?.innerText || 'æ–°æ‰‹ä¸Šè·¯',
            isUser: true
        };

        let combined = leaderboardData.map(d => ({
            ...d,
            visited_count: d.visited_count || 0
        }));

        combined.push(currentUser);
        combined.sort((a, b) => b.visited_count - a.visited_count);

        let userRank = 0;
        combined.forEach((item, index) => {
            const rank = index + 1;
            const isMe = item.isUser === true;
            if (isMe) userRank = rank;

            const tr = document.createElement('tr');
            if (isMe) tr.className = 'bg-primary/10';

            let rankBadge = `#${rank}`;
            if (rank === 1) rankBadge = 'ğŸ¥‡';
            if (rank === 2) rankBadge = 'ğŸ¥ˆ';
            if (rank === 3) rankBadge = 'ğŸ¥‰';

            tr.innerHTML = `
                <td class="font-bold">${rankBadge}</td>
                <td>${item.name}</td>
                <td>${item.visited_count}</td>
                <td><span class="badge badge-sm">${item.title}</span></td>
            `;
            tbody.appendChild(tr);
        });

        const userRankInfo = document.getElementById('user-rank-info');
        if (userRankInfo) userRankInfo.innerText = `ä½ çš„ç›®å‰æ’åï¼šç¬¬ ${userRank} å`;

        const shopTbody = document.getElementById('shop-leaderboard-body');
        if (shopTbody) {
            shopTbody.innerHTML = '';
            let sortedShops = [...allShops].sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
            let topShops = sortedShops.slice(0, 5);

            topShops.forEach((shop, index) => {
                const rank = index + 1;
                const tr = document.createElement('tr');
                let rankBadge = `#${rank}`;
            if (rank === 1) rankBadge = 'ğŸ¥‡';
            if (rank === 2) rankBadge = 'ğŸ¥ˆ';
            if (rank === 3) rankBadge = 'ğŸ¥‰';

            tr.innerHTML = `
                <td class="font-bold">${rankBadge}</td>
                <td>${shop.name}</td>
                <td><span class="badge badge-outline badge-sm">${shop.category}</span></td>
                <td>ğŸ”¥ ${shop.popularity || 0}</td>
            `;
            shopTbody.appendChild(tr);
        });
    }

        // Comparison table
        const compTbody = document.getElementById('comparison-body');
        if (compTbody) {
            compTbody.innerHTML = '';

            allShops.forEach(shop => {
                const isVisited = visitedShops.includes(shop.id);
                const visitors = shop.visitors || [];

                const tr = document.createElement('tr');
                if (isVisited) tr.className = 'bg-success/10';

                let tagsHtml = visitors.length > 0
                    ? visitors.map(v => `<span class="badge badge-ghost badge-sm mr-1">${v.trim()}</span>`).join('')
                    : '<span class="text-base-content/40 text-sm">å°šç„¡è³‡æ–™</span>';

                tr.innerHTML = `
                    <td>${shop.name}</td>
                    <td><span class="badge badge-outline badge-sm">${shop.category}</span></td>
                    <td>${isVisited ? '<span class="text-success">âœ… å·²æ”»ç•¥</span>' : '<span class="text-base-content/40">â¬œ æœªæ”»ç•¥</span>'}</td>
                    <td>${tagsHtml}</td>
                `;
                compTbody.appendChild(tr);
            });
        }
    }

    window.switchTab = function(tabName: string) {
        document.getElementById('tab-passport')?.classList.remove('tab-active');
        document.getElementById('tab-leaderboard')?.classList.remove('tab-active');
        document.getElementById('tab-progress')?.classList.remove('tab-active');

        if (tabName === 'passport') {
            document.getElementById('tab-passport')?.classList.add('tab-active');
            document.getElementById('passport-view')?.classList.remove('hidden');
            document.getElementById('leaderboard-view')?.classList.add('hidden');
            document.getElementById('progress-view')?.classList.add('hidden');
            if (mapRenderer) mapRenderer.invalidateSize();
        } else if (tabName === 'progress') {
            document.getElementById('tab-progress')?.classList.add('tab-active');
            document.getElementById('passport-view')?.classList.add('hidden');
            document.getElementById('leaderboard-view')?.classList.add('hidden');
            document.getElementById('progress-view')?.classList.remove('hidden');
        } else {
            document.getElementById('tab-leaderboard')?.classList.add('tab-active');
            document.getElementById('passport-view')?.classList.add('hidden');
            document.getElementById('leaderboard-view')?.classList.remove('hidden');
            document.getElementById('progress-view')?.classList.add('hidden');
            renderLeaderboard();
        }
    }

    window.updateUserName = function() {
        const newName = prompt('è«‹è¼¸å…¥ä½ çš„æ–°æš±ç¨±ï¼š', userName);
        if (newName && newName.trim() !== '') {
            userName = newName.trim();
            saveUserName(userName);
            renderLeaderboard();
        }
    }

    window.exportData = function() {
        const data = localStorage.getItem('visited_shops') || '[]';
        prompt("è«‹è¤‡è£½ä»¥ä¸‹ä»£ç¢¼ï¼Œåœ¨å¦ä¸€æ”¯æ‰‹æ©ŸåŒ¯å…¥ï¼š", data);
    }

    window.importData = function() {
        const data = prompt("è«‹è²¼ä¸ŠåŒ¯å‡ºä»£ç¢¼ï¼š");
        if (data) {
            try {
                const parsed = JSON.parse(data);
                if(Array.isArray(parsed)) {
                    // Logic was to persist, which effectively is handled by our addVisitedShop/saveVisitedShop 
                    // but we need to bulk replace. The user implementation was replacing the entire array.
                    // We don't have a bulk set function exposed, let me quickly fix inline or add to util? 
                    // Actually, for importData we should probably add a `setVisitedShops` to util or just direct usage here is technically 'storage' logic 
                    // but let's stick to using the utility. Wait, the utility `saveVisitedShops` IS exposed.
                    visitedShops = parsed;
                    saveVisitedShops(visitedShops);
                    location.reload();
                } else {
                    alert('æ ¼å¼éŒ¯èª¤');
                }
            } catch (e) {
                alert('ä»£ç¢¼ç„¡æ•ˆ');
            }
        }
    }

    window.resetData = function() {
        if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿé€™ç„¡æ³•å¾©åŸå–”ï¼')) {
            resetAllData();
            location.reload();
        }
    }

    window.locateUser = function() {
        if (!navigator.geolocation) {
            alert('ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½åŠŸèƒ½');
            return;
        }

        const btn = document.querySelector('button[onclick="locateUser()"]');
        if(btn) btn.classList.add('loading');

        navigator.geolocation.getCurrentPosition(
            (position) => {
                if(btn) btn.classList.remove('loading');
                const { latitude, longitude } = position.coords;
                
                if (mapRenderer) {
                    mapRenderer.setView([latitude, longitude], 15);
                    mapRenderer.addCurrentLocationMarker(latitude, longitude);
                }
            },
            (error) => {
                if(btn) btn.classList.remove('loading');
                console.error(error);
                let msg = 'ç„¡æ³•å–å¾—ä½ çš„ä½ç½®';
                if (error.code === 1) msg = 'è«‹å…è¨±ç€è¦½å™¨å­˜å–ä½ çš„ä½ç½®';
                else if (error.code === 2) msg = 'ç„¡æ³•åµæ¸¬åˆ°ä½ç½®';
                else if (error.code === 3) msg = 'å®šä½é€¾æ™‚';
                alert(msg);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    }
</script>

</body>
</html>
