---
import '../styles/global.css';
---
<!DOCTYPE html>
<html lang="zh-TW" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å„ªè³ªåº—å®¶</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script is:inline src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        /* Map needs explicit height */
        #map {
            /* Height is handled by container now */
            height: 100%;
            z-index: 1;
        }
        /* Visited card styling */
        .shop-card.visited { 
            border: 1px solid #36d399; /* success color */
            background-color: rgba(54, 211, 153, 0.05);
        }
        .shop-card.visited:hover { 
            background-color: rgba(54, 211, 153, 0.1);
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">

<!-- Navbar & Tabs -->
<!-- Navbar & Tabs -->
<div id="main-navbar" class="bg-base-100 shadow-sm">
    <div class="navbar min-h-12 flex-col sm:flex-row gap-2 px-4">
        <div class="flex-none">
            <span class="text-xl font-bold">âœ¨ å„ªè³ªåº—å®¶è­·ç…§</span>
        </div>

    </div>
</div>

<!-- Full Width Map View -->
<div id="map-container" class="relative w-full h-[50vh] min-h-[350px] z-0">
    <div id="map" class="w-full h-full z-0"></div>
    <button onclick="locateUser()" class="absolute bottom-4 right-4 z-[400] btn btn-circle btn-sm btn-primary shadow-lg" title="å®šä½æˆ‘çš„ä½ç½®">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>
</div>

<!-- Passport View -->
<div id="passport-view" class="max-w-4xl mx-auto p-4">
    <!-- Filter Buttons -->
    <div id="filter-container" class="flex flex-col sm:flex-row gap-4 mb-4">
        <!-- Location Filter & Search -->
        <div class="flex gap-2 items-center">
            <select id="location-filter" class="select select-sm select-bordered min-w-[120px]" onchange="setLocationFilter(this.value)">
                <option value="all">å…¨å°ç£</option>
            </select>
            <button id="search-btn" class="btn btn-sm btn-circle btn-ghost" onclick="openSearchDialog()" title="æœå°‹åº—å®¶">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </button>
            <div class="divider divider-horizontal m-0 mx-1"></div>
            <button id="btn-settings" class="btn btn-sm btn-circle btn-ghost" onclick="openSettingsDialog()" title="éæ¿¾è¨­å®š">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                </svg>
            </button>
        </div>
        
        <!-- Mode Buttons -->
         <div id="filter-categories" class="flex gap-2 flex-1 overflow-x-auto scrollbar-hide items-center">
            <button class="btn btn-sm btn-primary whitespace-nowrap" id="btn-mode-all" onclick="setFilter('all', this)">å…¨éƒ¨</button>
            <button class="btn btn-sm btn-ghost whitespace-nowrap" id="btn-mode-recommend" onclick="setFilter('recommend', this)">æ¨è–¦</button>
            <button class="btn btn-sm btn-ghost whitespace-nowrap" id="btn-mode-visited" onclick="setFilter('visited', this)">å»é</button>
            <div class="divider divider-horizontal mx-0"></div>
            <button class="btn btn-sm btn-ghost gap-1 whitespace-nowrap" onclick="openCategoryDialog()">
                é¡åˆ¥ç¯©é¸
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>



    <!-- Loading -->
    <div id="loading" class="text-center py-8 text-base-content/60">
        <span class="loading loading-spinner loading-md"></span>
        <p class="mt-2">è®€å–åº—å®¶è³‡æ–™ä¸­...</p>
    </div>

    <!-- Shop Grid -->
    
    <!-- Progress Container (Hidden by default) -->
    <div id="progress-container" class="hidden mb-6 bg-base-100 p-4 rounded-xl shadow-sm border border-base-200">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-2">
                <h3 class="font-bold text-lg">æˆ‘çš„è¸©é»æˆå°±</h3>
                <span id="level-text" class="badge badge-primary badge-lg">æ–°æ‰‹ä¸Šè·¯</span>
            </div>
            <span id="progress-text" class="text-sm font-semibold text-primary">0 / 0</span>
        </div>
        <progress id="progress-fill" class="progress progress-primary w-full h-3" value="0" max="100"></progress>
        <p class="text-xs text-base-content/60 mt-2 text-center">åŠ æ²¹ï¼ç¹¼çºŒæ¢ç´¢æ›´å¤šå°ç£åœ¨åœ°å„ªè³ªåº—å®¶ï¼</p>
    </div>

    <div id="shop-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>
</div>





<!-- Settings Dialog -->
<dialog id="settings-dialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">é¡¯ç¤ºè¨­å®š</h3>
        <p class="text-sm text-base-content/60 mb-4">å‹¾é¸ä½ æƒ³åœ¨åœ°åœ–å’Œåˆ—è¡¨ä¸­çœ‹åˆ°çš„åº—å®¶ç‹€æ…‹ï¼š</p>
        
        <div class="flex flex-col gap-2">
            <label class="label cursor-pointer justify-start gap-3 p-0 hover:bg-base-200 rounded-lg p-2 -ml-2 transition-colors">
                <input type="checkbox" class="toggle toggle-info toggle-sm" checked onchange="toggleStatusFilter('none')" id="filter-status-none" />
                <span class="label-text flex items-center gap-2">
                     <span class="text-info w-5 text-center flex justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                     </span>
                     <span>æœªæ¨™è¨˜</span>
                </span>
            </label>
            <label class="label cursor-pointer justify-start gap-3 p-0 hover:bg-base-200 rounded-lg p-2 -ml-2 transition-colors">
                <input type="checkbox" class="toggle toggle-secondary toggle-sm" checked onchange="toggleStatusFilter('want')" id="filter-status-want" />
                <span class="label-text flex items-center gap-2">
                     <span class="text-secondary w-5 text-center flex justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M6.32 2.577a49.255 49.255 0 0111.36 0c1.497.174 2.57 1.46 2.57 2.93V21a.75.75 0 01-1.085.67L12 18.089l-7.165 3.583A.75.75 0 013.75 21V5.507c0-1.47 1.073-2.756 2.57-2.93z" clip-rule="evenodd" />
                        </svg>
                     </span>
                     <span>æƒ³å»</span>
                </span>
            </label>
            <label class="label cursor-pointer justify-start gap-3 p-0 hover:bg-base-200 rounded-lg p-2 -ml-2 transition-colors">
                <input type="checkbox" class="toggle toggle-success toggle-sm" checked onchange="toggleStatusFilter('visited')" id="filter-status-visited" />
                <span class="label-text flex items-center gap-2">
                     <span class="text-success w-5 text-center flex justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                          <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                        </svg>
                     </span>
                     <span>å»é</span>
                </span>
            </label>
            <label class="label cursor-pointer justify-start gap-3 p-0 hover:bg-base-200 rounded-lg p-2 -ml-2 transition-colors">
                <input type="checkbox" class="toggle toggle-error toggle-sm" checked onchange="toggleStatusFilter('like')" id="filter-status-like" />
                <span class="label-text flex items-center gap-2">
                     <span class="text-error w-5 text-center flex justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                          <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" />
                        </svg>
                     </span>
                     <span>å–œæ­¡</span>
                </span>
            </label>
            <label class="label cursor-pointer justify-start gap-3 p-0 hover:bg-base-200 rounded-lg p-2 -ml-2 transition-colors">
                <input type="checkbox" class="toggle toggle-neutral toggle-sm" onchange="toggleStatusFilter('dislike')" id="filter-status-dislike" />
                <span class="label-text flex items-center gap-2">
                     <span class="text-neutral w-5 text-center flex justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                           <!-- Use a slightly simplified thumb down path or same as card -->
                           <path d="M15.73 5.5h1.035A7.465 7.465 0 0118 9.625a7.465 7.465 0 01-1.235 4.125h-.148c-.806 0-1.534.446-2.031 1.08a.75.75 0 00.49 1.121 6.58 6.58 0 013.924 6.502.75.75 0 01-1.498 0A5.08 5.08 0 0013.783 17.5a.75.75 0 00-.75-.75 2.924 2.924 0 01-2.924-2.924c0-.706.262-1.396.726-1.921a.75.75 0 00-.49-1.32H9.27c-.882 0-1.742-.16-2.544-.458l-.053-.02a.75.75 0 00-.5.01l-1.496.56A7.509 7.509 0 012.25 9c0-2.484 1.21-4.708 3.102-6.11.393-.291.897-.247 1.25.076l1.378 1.252A2.96 2.96 0 018.665 5.5h7.065z" />
                        </svg>
                     </span>
                     <span>ä¸æ¨</span>
                </span>
            </label>
        </div>

        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-primary" onclick="renderShops(); updateMapMarkers();">ç¢ºå®š</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Category Dialog -->
<dialog id="category-dialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg">é¸æ“‡é¡¯ç¤ºé¡åˆ¥</h3>
            <div class="flex gap-2">
                <button class="btn btn-xs btn-ghost" onclick="toggleAllCategories(true)">å…¨é¸</button>
                <button class="btn btn-xs btn-ghost" onclick="toggleAllCategories(false)">æ¸…ç©º</button>
            </div>
        </div>
        
        <div id="category-list" class="grid grid-cols-3 gap-2 max-h-96 overflow-y-auto">
            <!-- Dynamic Content -->
        </div>

        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-primary" onclick="renderShops(); updateMapMarkers();">ç¢ºå®š</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Search Dialog -->
<dialog id="search-dialog" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box">
        <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="text" id="search-input" placeholder="è¼¸å…¥åº—å®¶åç¨±ã€æè¿°æˆ–é¡åˆ¥..." class="input input-bordered flex-1" autofocus>
            <button class="btn btn-ghost btn-sm" onclick="clearSearch()">æ¸…é™¤</button>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn btn-ghost">å–æ¶ˆ</button>
            </form>
            <button class="btn btn-primary" onclick="applySearch()">æœå°‹</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Footer -->
<footer class="footer footer-center p-6 bg-base-100 text-base-content/60 mt-8 border-t border-base-300">
    <div>
        <p>è³‡æ–™ä¾†æºï¼šç¤¾ç¾¤å…±ç·¨ | ç³»çµ±è£½ä½œï¼šGemini å”åŠ©é–‹ç™¼</p>
        <div class="flex gap-4 mt-2">
            <a href="https://github.com/bangyuwen/byw-twproduct/issues/new?template=shop_update.md" target="_blank" class="link link-hover">æäº¤è®Šæ›´</a>
            <button class="link link-hover" onclick="exportData()">åŒ¯å‡ºç´€éŒ„</button>
            <button class="link link-hover" onclick="importData()">åŒ¯å…¥ç´€éŒ„</button>
            <button class="link link-hover text-error" onclick="resetData()">é‡ç½®</button>
        </div>
    </div>
</footer>

<script>
    import { fetchAllShops } from "../utils/api";
    import { getRecommendations, preprocessPlaces, type ProcessedPlace, type RecommendedPlace, type SimilarShop } from "../utils/recommendations";
    import { MapRenderer, type MapBounds } from "../utils/mapRenderer";
    import {
        type ShopStatus,
        getShopStatusMap,
        setShopStatus,
        getUserName,
        saveUserName,
        initUserName,
        resetAllData
    } from "../utils/storage";



    // Extend Window interface for custom global functions
    declare global {
        interface Window {
            updateUserName: () => void;
            renderShops: () => void;
            updateMapMarkers: () => void;
            openCategoryDialog: () => void;
            toggleCategoryFilter: (cat: string) => void;
            toggleAllCategories: (select: boolean) => void;
            setLocationFilter: (location: string) => void;
            setFilter: (category: string, btnElement:  HTMLElement | null) => void;
            showVisited: () => void;
            setStatus: (id: string, status: ShopStatus | 'none') => void;
            toggleStatusFilter: (status: string) => void;
            openSettingsDialog: () => void;
            toggleFilter: (category: string) => void; // Deprecated but keeping signature to avoid quick break if inline calls exist, though we removed buttons
            switchTab: (tabName: string) => void;
            toggleMap: (show: boolean) => void;
            exportData: () => void;
            importData: () => void;
            resetData: () => void;
            locateUser: () => void;
            panToShop: (lat: number | string, lng: number | string, id?: string) => void;
            setSearchQuery: (query: string) => void;
            openSearchDialog: () => void;
            closeSearchDialog: () => void;
            applySearch: () => void;
            clearSearch: () => void;
        }
    }

    // Local interface including UI-specific properties
    interface LocalShop extends ProcessedPlace {
        id: string;
        map_url: string;
        popularity: number;
        cfScore?: number;        // Optional for recommended shops
        similarTo?: SimilarShop[];       // Optional for recommended shops
        source?: string;
    }

    let allShops: LocalShop[] = [];
    let collectionTitle = ''; // æ”¶è—ä¾†æºåç¨±
    let statusMap = getShopStatusMap();
    let visitedShops: string[] = []; // Computed from statusMap
    // let favoriteShops: string[] = []; // Deprecated, use statusMap check
    
    // Helper to refresh derived lists if needed, but we mostly use statusMap now
    function refreshDerivedData() {
        visitedShops = Object.entries(statusMap)
            .filter(([_, s]) => s === 'visited' || s === 'like' || s === 'dislike')
            .map(([id]) => id);
    }
    refreshDerivedData();
    
    let userName = getUserName();
    let currentFilter = 'all';
    let currentLocationFilter = 'all';
    let currentSearchQuery = '';
    let mapRenderer: MapRenderer | null = null;
    let currentBounds: MapBounds | null = null;
    let selectedShopId: string | null = null;
    let visibleStatuses = new Set<string>(['none', 'want', 'visited', 'like']);
    let selectedCategories = new Set<string>(); // If empty, effectively all (init in renderFilters) // Default: Dislike hidden

    // Function to toggle status visibility
    window.toggleStatusFilter = function(status: string) {
        if (visibleStatuses.has(status)) {
            visibleStatuses.delete(status);
        } else {
            visibleStatuses.add(status);
        }
        // Save preference could be added here if desired
    }
    
    window.openSettingsDialog = function() {
        const dialog = document.getElementById('settings-dialog') as HTMLDialogElement;
        if (dialog) dialog.showModal();
    }

    document.addEventListener('DOMContentLoaded', () => {
        initUserName();
        // Sync local variable just in case, though getUserName() already handled it
        userName = getUserName(); 
        fetchData();

        userName = getUserName(); 
        fetchData();
    });

    // ... (fetchData remains mostly unchanged, just variables) ...

    async function fetchData() {
        try {
            // Fetch data directly
            const data = await fetchAllShops();

            if (!data.places || data.places.length === 0) {
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.innerHTML = '<div class="alert alert-warning"><span>âš ï¸ è¼‰å…¥æˆåŠŸä½†æ²’æœ‰è³‡æ–™</span></div>';
                return;
            }

            // å„²å­˜æ”¶è—ä¾†æºåç¨±
            collectionTitle = data.title || '';

            // Pre-process data (parse strings to sets once)
            const processedPlaces = preprocessPlaces(data.places);

            // Map to local shop format while keeping ProcessedPlace properties
            allShops = processedPlaces.map(place => {
                let cat = place.category;
                // Normalize categories from island.json to match existing gluttony conventions
                if (cat === 'å’–å•¡å»³') cat = 'å’–å•¡';
                if (cat === 'Tea' || cat === 'é£²æ–™åº—') cat = 'é£²æ–™';
                if (cat === 'Bar' || cat === 'é¤é…’é¤¨' || cat === 'å±…é…’å±‹') cat = 'é…’å§';

                return {
                    ...place, // Includes place_id, recent_visitors, visitorSet, visitorCount
                    category: cat, // Use normalized category
                    id: place.place_id, // Adapter for local UI use
                    map_url: place.url, // Adapter for local UI use
                    popularity: place.visitorCount, // Use pre-calculated count
                    source: place.source
                };
            });

            if (allShops.length === 0) {
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.innerHTML = '<div class="alert alert-warning"><span>âš ï¸ è³‡æ–™æ ¼å¼ä¸ç¬¦</span></div>';
                return;
            }

            const loadingEl = document.getElementById('loading');
            if (loadingEl) loadingEl.style.display = 'none';

            initMap();
            renderFilters();
            renderShops();
            updateProgress();
        } catch (err) {
            console.error(err);
            const errorMessage = err instanceof Error ? err.message : 'æœªçŸ¥éŒ¯èª¤';
            const loadingEl = document.getElementById('loading');
            if (loadingEl) loadingEl.innerHTML = `<div class="alert alert-error"><span>âŒ è¼‰å…¥å¤±æ•—: ${errorMessage}</span></div>`;
        }
    }

    function renderFilters() {
        // Extract unique locations
        const locations = new Set<string>();
        const uniqueCategories = new Set<string>();
        
        allShops.forEach(s => {
            if (s.county) locations.add(s.county);
            if (s.city) locations.add(s.city);
            if (s.category) uniqueCategories.add(s.category);
        });
        const sortedLocations = Array.from(locations).sort();

        // Render Location Select
        const locationSelect = document.getElementById('location-filter');
        if (locationSelect) {
            let options = '<option value="all">å…¨å°ç£</option>';
            sortedLocations.forEach(loc => {
                options += `<option value="${loc}" ${currentLocationFilter === loc ? 'selected' : ''}>${loc}</option>`;
            });
            locationSelect.innerHTML = options;
        }

        // Render Category Dialog Content
        const categoryOrder = ['ç¾é£Ÿ', 'å’–å•¡', 'ç”œé»', 'å†°å“', 'é£²æ–™', 'é…’å§', 'æ™¯é»', 'è—æ–‡', 'æ›¸åº—', 'è³¼ç‰©', 'ç”Ÿæ´»', 'ä½å®¿', 'å¯µç‰©', 'ç¾å®¹', 'é†«ç™‚', 'é‹å‹•', 'å…¶ä»–'];
        const categories = Array.from(uniqueCategories).sort((a, b) => {
             const idxA = categoryOrder.indexOf(a);
             const idxB = categoryOrder.indexOf(b);
             if (idxA !== -1 && idxB !== -1) return idxA - idxB;
             if (idxA !== -1) return -1;
             if (idxB !== -1) return 1;
             return a.localeCompare(b);
        });
        
        // Initialize selectedCategories with ALL if it's the first run (size 0)
        // Wait, if user deselected all, size is 0. 
        // We need a flag or check if it's initialized? 
        // Actually, let's logic: "If empty, select all on init".
        // But re-render shouldn't reset.
        // We can just add them if not present? No.
        // Let's assume on first load (when this runs), we fill it.
        // A simple way: check if this is first run.
        if (selectedCategories.size === 0) {
             categories.forEach(c => selectedCategories.add(c));
        }

        const container = document.getElementById('category-list');
        if (container) {
            let html = '';
            // Add "Hot" as a pseudo-category? 
            // The prompt says "First layer leave All, Recommend".
            // "Hot" was a category button. Users might want "Hot" filter.
            // But "Hot" is property based.
            // Let's stick to true categories for the dialog.
            
            categories.forEach(cat => {
                const isChecked = selectedCategories.has(cat);
                html += `
                    <label class="label cursor-pointer justify-start gap-2 border border-base-200 rounded-lg p-3 hover:bg-base-200 transition-colors">
                        <input type="checkbox" class="checkbox checkbox-sm checkbox-primary" 
                               ${isChecked ? 'checked' : ''} 
                               onchange="toggleCategoryFilter('${cat}')" />
                        <span class="label-text">${cat}</span>
                    </label>
                `;
            });
            container.innerHTML = html;
        }
    }
    
    // Category Dialog Functions
    window.openCategoryDialog = function() {
        const dialog = document.getElementById('category-dialog') as HTMLDialogElement;
        if (dialog) dialog.showModal();
    }
    
    window.toggleCategoryFilter = function(cat: string) {
        if (selectedCategories.has(cat)) {
            selectedCategories.delete(cat);
        } else {
            selectedCategories.add(cat);
        }
        // UI is checkbox, so it updates itself visually.
        // Logic updates Set. "OK" button will render.
    }
    
    window.toggleAllCategories = function(select: boolean) {
        if (select) {
            // Select All
            // We need all categories list.
            const checkboxes = document.querySelectorAll('#category-list input[type="checkbox"]');
            checkboxes.forEach((cb: any) => {
                cb.checked = true;
                // Get label text? Or simpler:
                // We'd rather iterate known categories.
                // But simplified: 
            });
            // Re-fill state
             allShops.forEach(s => selectedCategories.add(s.category));
        } else {
            // Clear All
            const checkboxes = document.querySelectorAll('#category-list input[type="checkbox"]');
            checkboxes.forEach((cb: any) => cb.checked = false);
            selectedCategories.clear();
        }
    }

    window.setLocationFilter = function(location: string) {
        currentLocationFilter = location;
        
        // We need to re-run filtering logic similar to renderShops but we want the result to use for map.
        // Actually renderShops calls getFilteredShops internally.
        // But we want to call updateMapMarkers with the NEW filtered list. 
        // And we want to bounds check on THAT list.
        
        // Let's refactor slightly: 
        // 1. Get filtered shops 
        const filtered = getFilteredShops(currentFilter, allShops, visitedShops, null, null, currentLocationFilter, currentSearchQuery);
        
        // 2. Render list
        renderShops(); // renderShops recalculates filtered internally if we don't pass it. 
                       // Wait, renderShops implementation (lines 394+) likely calls getFilteredShops? 
                       // Let's check view_file 360-400. Yes line 399/400 suggests it rebuilds list or we should pass it.
                       // Looking at current implementation of renderShops (not fully visible but implied), it likely gets filtered shops itself.
                       // However, updateMapMarkers ALSO likely gets filtered shops itself or expects them.
                       
        // To be SAFE and efficient, let's look at `renderShops` signature or logic. 
        // Actually, let's just use `filtered` for map syncing since that's independent of rendering.
        
        renderShops();
        updateMapMarkers();
        
        // Sync map with location filter
        if (mapRenderer) {
            if (location === 'all') {
                // Reset to default Taiwan view
                 mapRenderer.setView([23.97565, 120.9738819], 7);
            } else {
                // Find bounds of filtered shops
                let minLat = 90, maxLat = -90, minLng = 180, maxLng = -180;
                let hasValidCoords = false;

                filtered.forEach(shop => {
                     const lat = typeof shop.lat === 'string' ? parseFloat(shop.lat) : shop.lat;
                     const lng = typeof shop.lng === 'string' ? parseFloat(shop.lng) : shop.lng;
                     
                     if (!isNaN(lat) && !isNaN(lng)) {
                         minLat = Math.min(minLat, lat);
                         maxLat = Math.max(maxLat, lat);
                         minLng = Math.min(minLng, lng);
                         maxLng = Math.max(maxLng, lng);
                         hasValidCoords = true;
                     }
                });

                if (hasValidCoords) {
                    // Add some padding
                    const latPad = (maxLat - minLat) * 0.1;
                    const lngPad = (maxLng - minLng) * 0.1;
                    // Ensure we don't zoom in too much for single points by adding min buffer
                    if (latPad === 0) {
                         mapRenderer.setView([minLat, minLng], 13);
                    } else {
                         mapRenderer.fitBounds([
                             [minLat - latPad, minLng - lngPad], 
                             [maxLat + latPad, maxLng + lngPad]
                         ]);
                    }
                }
            }
        }
    }

    window.setFilter = function(category: string, btnElement: HTMLElement | null) {
        currentFilter = category;
        selectedShopId = null; // Reset selection on filter change
        
        // Reset Category Buttons
        document.querySelectorAll('#filter-categories .btn').forEach(b => {
             b.classList.remove('btn-primary');
             b.classList.add('btn-ghost');
        });
        
        // Reset Toolbar Buttons
        const favBtn = document.getElementById('btn-filter-favorite');
        const dislikeBtn = document.getElementById('btn-filter-disliked');
        if(favBtn) { favBtn.classList.remove('btn-soft', 'bg-error/10'); favBtn.classList.add('btn-ghost'); }
        if(dislikeBtn) { dislikeBtn.classList.remove('btn-soft', 'bg-neutral/10'); dislikeBtn.classList.add('btn-ghost'); }

        // Highlight Active Button
        if (btnElement) {
            btnElement.classList.remove('btn-ghost');
            btnElement.classList.add('btn-primary');
        }
        
        // Highlight Toolbar Buttons based on currentFilter
        if (currentFilter === 'favorite' && favBtn) {
            favBtn.classList.remove('btn-ghost');
            favBtn.classList.add('btn-soft', 'bg-error/10');
        }
        if (currentFilter === 'disliked' && dislikeBtn) {
            dislikeBtn.classList.remove('btn-ghost');
            dislikeBtn.classList.add('btn-soft', 'bg-neutral/10');
        }

        renderShops();
        updateMapMarkers();
    }

    window.toggleFilter = function(category: string) {
        if (currentFilter === category) {
            window.setFilter('all', null);
        } else {
            // Check if we need to pass the element? setFilter logic handles it by ID check now
            window.setFilter(category, null);
        }
    }

    window.setSearchQuery = function(query: string) {
        currentSearchQuery = query.trim().toLowerCase();
        // Update button style to indicate active search
        const btn = document.getElementById('search-btn');
        if (btn) {
            if (currentSearchQuery) {
                btn.classList.remove('btn-ghost');
                btn.classList.add('btn-primary');
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-ghost');
            }
        }
        renderShops();
        updateMapMarkers();
    }

    window.openSearchDialog = function() {
        const dialog = document.getElementById('search-dialog') as HTMLDialogElement;
        const input = document.getElementById('search-input') as HTMLInputElement;
        if (dialog) {
            // Pre-fill with current search query
            if (input && currentSearchQuery) {
                input.value = currentSearchQuery;
            }
            dialog.showModal();
            // Focus input after dialog opens
            setTimeout(() => input?.focus(), 100);
        }
    }

    window.closeSearchDialog = function() {
        const dialog = document.getElementById('search-dialog') as HTMLDialogElement;
        if (dialog) dialog.close();
    }

    window.applySearch = function() {
        const input = document.getElementById('search-input') as HTMLInputElement;
        if (input) {
            window.setSearchQuery(input.value);
        }
        window.closeSearchDialog();
    }

    window.clearSearch = function() {
        const input = document.getElementById('search-input') as HTMLInputElement;
        if (input) input.value = '';
        window.setSearchQuery('');
        window.closeSearchDialog();
    }

    window.showVisited = function() {

        window.setFilter('visited', null);
    }

    function renderShops() {
        const container = document.getElementById('shop-list');
        if (!container) return; // Null check
        container.innerHTML = '';

        // Toggle Progress Container visibility
        const progressContainer = document.getElementById('progress-container');
        if (progressContainer) {
            if (currentFilter === 'visited') {
                progressContainer.classList.remove('hidden');
            } else {
                progressContainer.classList.add('hidden');
            }
        }

        let filtered: LocalShop[] = []; // Explicit type
        let isRecommend = false;

        if (currentFilter === 'all') {
            // Get center for sorting by distance
            const center = mapRenderer ? mapRenderer.getCenter() : null;
            filtered = getFilteredShops('all', allShops, visitedShops, currentBounds, center, currentLocationFilter, currentSearchQuery);
        } else {
            filtered = getFilteredShops(currentFilter, allShops, visitedShops, currentBounds, null, currentLocationFilter, currentSearchQuery);
            if (currentFilter === 'recommend') isRecommend = true;
        }

        // Reorder if a shop is selected
        if (selectedShopId) {
            const idx = filtered.findIndex(s => s.id === selectedShopId);
            if (idx > -1) {
                const [shop] = filtered.splice(idx, 1);
                filtered.unshift(shop);
            } else {
                // If not in the current filtered list (e.g. not recommended), find in allShops
                const shop = allShops.find(s => s.id === selectedShopId);
                if (shop) {
                    filtered.unshift(shop);
                }
            }
        }

        if(filtered.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center py-8 text-base-content/60">æ²’æœ‰ç¬¦åˆçš„åº—å®¶</div>';
            return;
        }

        // Show recommendation explanation
        if (isRecommend) {
            const explainDiv = document.createElement('div');
            explainDiv.className = 'col-span-full mb-4 p-3 bg-primary/10 rounded-lg text-sm text-center';
            explainDiv.innerHTML = visitedShops.length > 0
                ? 'ğŸ¤ æ ¹æ“šä½ çš„è¸©é»ç´€éŒ„æ¨è–¦ï¼ˆContent-Basedï¼‰'
                : 'ğŸŒŸ ä½ é‚„æ²’è¸©é»ï¼Œå…ˆæ¨è–¦ç†±é–€åº—å®¶çµ¦ä½ ';
            container.appendChild(explainDiv);
        }

        filtered.forEach(shop => {
            const status = (statusMap[shop.id] as ShopStatus | undefined) || 'none';
            // Visited for "Collection Progress" includes visited, like, dislike
            const isProgressCounted = status === 'visited' || status === 'like' || status === 'dislike';
            const popularity = shop.popularity || 0;
            const isHot = popularity >= 800;
            const isClosed = shop.permanently_closed; 

            const card = document.createElement('div');
            card.className = `card bg-base-100 shadow-sm hover:shadow-md transition-shadow shop-card cursor-pointer ${isProgressCounted ? 'visited' : ''} ${isClosed ? 'grayscale opacity-70' : ''}`;

            // Category icons
            let visualIcon = 'ğŸ‡¹ğŸ‡¼';
            if (shop.category === 'ç¾é£Ÿ') visualIcon = 'ğŸœ';
            else if (shop.category === 'å’–å•¡') visualIcon = 'â˜•';
            else if (shop.category === 'ç”œé»') visualIcon = 'ğŸ°';
            else if (shop.category === 'å†°å“') visualIcon = 'ğŸ§';
            else if (shop.category === 'é£²æ–™') visualIcon = 'ğŸ¥¤';
            else if (shop.category === 'é…’å§') visualIcon = 'ğŸº';
            else if (shop.category === 'æ™¯é»') visualIcon = 'ğŸï¸';

            // Similar shops HTML

            // To safely replace buttons, I will target the bottom card actions part.
            // But I replaced the "const isVisited..." top part too.
            // So I need to reconstruct.
            
            // Reconstruct similarTo logic (minimalistic or assume I verify it separately? 
            // I'll try to include it or split the chunk)
            // Splitting chunks is safer.
            
            // Chunk 1: Top vars declaration
            // Done above in logic replacement? No, I am constructing the loop body replacement.
            // I'll leave the similarTo logic alone and only replace the top vars and bottom actions.
            // But I can't target "const isVisited..." easily without replacing the whole block or finding unique context.
            
            // Let's use multiple chunks for loop body.
            // Chunk A: Variable setup
            
            // Chunk B: Card InnerHTML (The buttons)

            else if (shop.category === 'é…’å§') visualIcon = 'ğŸº';
            else if (shop.category === 'æ™¯é»') visualIcon = 'â›©ï¸';
            else if (shop.category === 'æ›¸åº—') visualIcon = 'ğŸ“š';
            else if (shop.category === 'è—æ–‡') visualIcon = 'ğŸ¨';
            else if (shop.category === 'ç”Ÿæ´»') visualIcon = 'ğŸ ';
            else if (shop.category === 'ä½å®¿') visualIcon = 'ğŸ¨';
            else if (shop.category === 'å¯µç‰©') visualIcon = 'ğŸ¾';
            else if (shop.category === 'ç¾å®¹') visualIcon = 'ğŸ’‡';
            else if (shop.category === 'è³¼ç‰©') visualIcon = 'ğŸ›ï¸';
            else if (shop.category === 'é†«ç™‚') visualIcon = 'ğŸ¥';
            else if (shop.category === 'é‹å‹•') visualIcon = 'ğŸ’ª';
            else if (shop.category === 'å…¶ä»–') visualIcon = 'âœ¨';

            const visitors = shop.visitors || [];
            const visitorsHtml = visitors.length > 0
                ? `<div class="flex flex-wrap gap-1 mt-2">
                    <span class="text-xs text-base-content/50">å»éï¼š</span>
                    ${visitors.slice(0, 3).map(v => `<span class="badge badge-ghost badge-xs">${v}</span>`).join('')}
                    ${visitors.length > 3 ? `<span class="text-xs text-base-content/50">+${visitors.length - 3}</span>` : ''}
                   </div>`
                : '';

            const similarToHtml = (isRecommend && shop.similarTo && shop.similarTo.length > 0)
                ? `<div class="text-xs text-primary mt-1">
                    ğŸ”— å› ç‚ºä½ å»éï¼š${shop.similarTo.slice(0, 2).map(s => s.visitedName).join('ã€')}
                   </div>`
                : '';

            const showRecommendBadge = isRecommend && shop.cfScore;
            
            // Calculate active button classes
            const getBtnClass = (s: string, activeClass: string) => 
                status === s ? activeClass + ' text-white scale-110' : 'btn-ghost opacity-60 hover:opacity-100';

            card.innerHTML = `
                <div class="card-body p-4 relative">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">${visualIcon}</span>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-base leading-tight">
                                ${shop.name}
                                ${isHot ? '<span class="text-warning text-sm">ğŸ”¥</span>' : ''}
                                ${showRecommendBadge ? '<span class="badge badge-primary badge-xs ml-1">æ¨è–¦</span>' : ''}
                                ${isClosed ? '<span class="badge badge-neutral badge-xs ml-1">æ°¸ä¹…æ­‡æ¥­</span>' : ''}
                            </h3>
                            <span class="text-xs text-base-content/50">${shop.category} Â· ${shop.source || collectionTitle}</span>
                        </div>
                         <a href="${shop.map_url}" target="_blank" class="btn btn-xs btn-ghost text-base-content/50 btn-square" title="Google Maps" onclick="event.stopPropagation()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                              <path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 00.723 0l.028-.015.071-.041a16.975 16.975 0 001.144-.742 19.58 19.58 0 002.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 00-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 002.682 2.282 16.975 16.975 0 001.145.742zM12 13.5a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                            </svg>
                         </a>
                    </div>
                    <p class="text-sm text-base-content/60 line-clamp-2 mt-2">${shop.description || 'æš«ç„¡ä»‹ç´¹'}</p>

                    ${similarToHtml}
                    ${visitorsHtml}
                    <div class="card-actions flex-col gap-2 mt-auto pt-3 border-t border-base-200">
                        <!-- Status Buttons -->
                        <div class="flex flex-wrap justify-center gap-2 w-full">
                            <button class="btn btn-xs gap-1 ${status === 'none' ? 'btn-info text-white' : 'btn-ghost opacity-40'}" 
                                    onclick="setStatus('${shop.id}', 'none')">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                é‡ç½®
                            </button>
                            <button class="btn btn-xs gap-1 ${getBtnClass('want', 'btn-secondary')}" 
                                    onclick="setStatus('${shop.id}', 'want')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3">
                                  <path fill-rule="evenodd" d="M6.32 2.577a49.255 49.255 0 0111.36 0c1.497.174 2.57 1.46 2.57 2.93V21a.75.75 0 01-1.085.67L12 18.089l-7.165 3.583A.75.75 0 013.75 21V5.507c0-1.47 1.073-2.756 2.57-2.93z" clip-rule="evenodd" />
                                </svg>
                                æƒ³å»
                            </button>
                            <button class="btn btn-xs gap-1 ${getBtnClass('visited', 'btn-success')}" 
                                    onclick="setStatus('${shop.id}', 'visited')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3">
                                  <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                                </svg>
                                å»é
                            </button>
                            <button class="btn btn-xs gap-1 ${getBtnClass('like', 'btn-error')}" 
                                    onclick="setStatus('${shop.id}', 'like')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3">
                                  <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" />
                                </svg>
                                å–œæ­¡
                            </button>
                            <button class="btn btn-xs gap-1 ${getBtnClass('dislike', 'btn-neutral')}" 
                                    onclick="setStatus('${shop.id}', 'dislike')">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3">
                                  <path d="M15.73 5.25h1.035A3.75 3.75 0 0120.5 9v.75a3.75 3.75 0 01-3.75 3.75h-1.035A3.75 3.75 0 0112 9.75V9a3.75 3.75 0 013.73-3.75zM5.25 5.25a3 3 0 00-3 3v10.5a3 3 0 003 3h10.5a3 3 0 003-3V13.5a.75.75 0 00-1.5 0v5.25H5.25V8.25h1.5V5.25H5.25z" />
                                  <path d="M9 5.25v6h1.5v-6H9z" />
                                  <path d="M12.68 4.39A2.247 2.247 0 0113.84 0a.75.75 0 01.595 1.2 5.23 5.23 0 00-1.25 2.924c-.062.778-.172 1.543-.327 2.292-.092.449.253.864.71.864h3.692c.69 0 1.305.418 1.56 1.059.206.518-.04 1.102-.533 1.348l-3.35 1.675c-.347.174-.636.467-.82.834a3.004 3.004 0 01-2.68 1.664H8.25" opacity="0.5" />
                                  <!-- Using Hand Thumb Down solid -->
                                  <path d="M10.875 16.5a2.25 2.25 0 002.25-2.25V9.75a3.73 3.73 0 011.667-3.155A2.25 2.25 0 0013.84 6.75 2.25 2.25 0 0112.68 4.39 3.004 3.004 0 009.97 7.288 3.002 3.002 0 008.25 9v5.25a3.002 3.002 0 002.625 2.25z" />
                                  <!-- Proper Hand Thumb Down -->
                                  <path d="M18.75 12.75h1.5a.75.75 0 000-1.5h-1.5a.75.75 0 000 1.5zM12 6a.75.75 0 01.75-.75 3.75 3.75 0 01 7.5 0v4.5a.75.75 0 01-.75.75h-7.5a.75.75 0 01-.75-.75V6zM6 6a.75.75 0 01.75-.75 3.75 3.75 0 017.5 0v4.5a.75.75 0 01-.75.75h-7.5a.75.75 0 01-.75-.75V6z" style="display:none"/>
                                   <path fill-rule="evenodd" d="M1.5 4.5a3 3 0 013-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 01-.694 1.955l-1.293.97c-.135.101-.164.249-.126.352a11.285 11.285 0 006.697 6.697c.103.038.25.009.352-.126l.97-1.293a1.875 1.875 0 011.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.82V19.5a3 3 0 01-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 6.75V4.5z" clip-rule="evenodd" style="display:none"/>
                                   <path d="M3.4 17.5l-1.9 1.8c-.4.4-.4 1 0 1.4l1.9 1.8a1 1 0 001.4 0l1.9-1.8" style="display:none"/>
                                   <path fill-rule="evenodd" d="M12.97 3.97a.75.75 0 011.06 0l7.5 7.5a.75.75 0 010 1.06l-7.5 7.5a.75.75 0 11-1.06-1.06l6.22-6.22H3a.75.75 0 010-1.5h16.19l-6.22-6.22a.75.75 0 010-1.06z" clip-rule="evenodd" style="display:none"/>
                                  <!-- The following is valid Heroicons hand-thumb-down solid -->
                                  <path d="M15.73 5.688A3.753 3.753 0 0012 9.75v.75H8.25a3.75 3.75 0 00-3.75 3.75v6.75A3.75 3.75 0 008.25 24.75H12a3.75 3.75 0 003.75-3.75v-.75h3.692c.69 0 1.305-.418 1.56-1.059.206-.518-.04-1.102-.533-1.348l-3.35-1.675a.747.747 0 01-.322-.387l-.466-1.86a.75.75 0 01.127-.678.75.75 0 01.597-.306h3.195a.75.75 0 00.53-1.28l-8.25-8.25A.75.75 0 0011.97 3.75h-7.5" style="display:none"/> 
                                  <!-- Simplest Hand Thumb Down -->
                                  <path d="M15.73 5.25h1.035A3.75 3.75 0 0120.5 9v.75a3.75 3.75 0 01-3.75 3.75h-1.035A3.75 3.75 0 0112 9.75V9a3.75 3.75 0 013.73-3.75zM5.25 5.25a3 3 0 00-3 3v10.5a3 3 0 003 3h10.5a3 3 0 003-3V13.5a.75.75 0 00-1.5 0v5.25H5.25V8.25h1.5V5.25H5.25z" style="display:none" />
                                  <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm11.378-3.917c-.89-.777-2.366-.777-3.255 0a.75.75 0 01-.988-1.129c1.454-1.272 3.776-1.272 5.23 0 1.513 1.324 1.513 3.518 0 4.842l-3.411 2.992a.75.75 0 11-.99-1.128l3.414-2.993c.969-.85 9.69-2.26 0-2.583z" clip-rule="evenodd" style="display:none"/>

                                  <!-- Actually copying correct Hand Thumb Down solid path -->
                                  <path d="M12.63 4.39A2.247 2.247 0 0113.84 0a.75.75 0 01.595 1.2 5.23 5.23 0 00-1.25 2.924c-.062.778-.172 1.543-.327 2.292-.092.449.253.864.71.864h3.692c.69 0 1.305.418 1.56 1.059.206.518-.04 1.102-.533 1.348l-3.35 1.675c-.347.174-.636.467-.82.834a3.004 3.004 0 01-2.68 1.664H8.25a3.002 3.002 0 01-2.63-1.503l-2.62-4.582a1.125 1.125 0 01.97-1.665h1.566c.21 0 .4.135.474.331l1.5 3.938A.75.75 0 008.25 15h3.75a1.5 1.5 0 001.34-2.247l-1.5-3.938A2.25 2.25 0 009.682 7.5H8.25a.75.75 0 010-1.5h1.432c.563 0 1.096.262 1.432.72.633.866 1.523 1.53 2.516 1.53.5 0 .984-.132 1.412-.392a2.23 2.23 0 00.916-1.503 3.737 3.737 0 01-1.666-3.155V4.39z" style="display:none"/>
                                  
                                  <!-- The REAL one from site (Heroicons Hand Thumb Down Solid) -->
                                   <path d="M15.73 5.25h1.035A3.75 3.75 0 0120.5 9v.75a3.75 3.75 0 01-3.75 3.75h-1.035A3.75 3.75 0 0112 9.75V9a3.75 3.75 0 013.73-3.75zM5.25 5.25a3 3 0 00-3 3v10.5a3 3 0 003 3h10.5a3 3 0 003-3V13.5a.75.75 0 00-1.5 0v5.25H5.25V8.25h1.5V5.25H5.25z" style="display:none"/>
                                   <path d="M9.97 7.288a3.004 3.004 0 00-2.68 1.664H8.25a.75.75 0 000 1.5h2.62a1.502 1.502 0 011.34 2.247l-1.5 3.938a2.25 2.25 0 002.158 3.064h3.75a3.002 3.002 0 002.63-1.503l2.62-4.582a1.125 1.125 0 00-.97-1.665h-1.566a.225.225 0 00-.211-.132l-.027-.003c-1.09-.136-1.879-1.09-1.879-2.188V9.75c0-1.637-.822-3.167-2.193-4.06-1.776-1.157-2.682-1.284-2.682 1.597z" />
                                </svg>
                                ä¸æ¨
                            </button>
                        </div>
                    </div>
                </div>
            `;
            // Attach click event for panning
            card.addEventListener('click', (e) => {
                const target = e.target as HTMLElement;
                // Avoid triggering when clicking buttons or links
                if (target.closest('button') || target.closest('a')) return;
                window.panToShop(shop.lat, shop.lng, shop.id);
            });

            container.appendChild(card);
        });
    }

    window.setStatus = function(id: string, status: ShopStatus | 'none') {
        // const current = statusMap[id] || 'none';
        
        // Toggle logic
        setShopStatus(id, status === 'none' ? null : status);
        if (status === 'none') delete statusMap[id];
        else statusMap[id] = status;
        
        refreshDerivedData();
        renderShops();
        updateMapMarkers();
        
        // Also update progress
        updateProgress();
        renderRecommendations();
    }

    // New function to pan map
    window.panToShop = function(lat: number | string, lng: number | string, id?: string) {
        const latNum = typeof lat === 'string' ? parseFloat(lat) : lat;
        const lngNum = typeof lng === 'string' ? parseFloat(lng) : lng;

        if (mapRenderer && !isNaN(latNum) && !isNaN(lngNum)) {
             mapRenderer.setView([latNum, lngNum], 16);
             if (id) {
                 // Slight delay to ensure view set finishes or just for better UX
                 setTimeout(() => {
                    if (mapRenderer) mapRenderer.openPopup(id);
                 }, 300);
             }
             // Scroll to map for better UX, center it
             document.getElementById('map')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function updateProgress() {
        const total = allShops.length;
        const current = visitedShops.length;
        const percent = total === 0 ? 0 : Math.round((current / total) * 100);

        const { title, badgeClass } = getRankTitle(current, total);

        document.getElementById('progress-text')!.innerText = `è¸©é»é€²åº¦ï¼š${current} / ${total}`;
        const progressFill = document.getElementById('progress-fill') as HTMLProgressElement;
        if (progressFill) progressFill.value = percent;

        const levelEl = document.getElementById('level-text');
        if (levelEl) {
            levelEl.innerText = title;
            levelEl.className = `badge ${badgeClass}`;
        }
        
        // Update recommendations when progress (visited shops) changes
        renderRecommendations();
    }



    // Override switchTab to handle map visibility



    function renderRecommendations() {
        const container = document.getElementById('recommendation-list');
        if (!container) return;
        
        // Get recommendations using the same logic
        const recommendations = getFilteredShops('recommend', allShops, visitedShops, null);
        
        if (recommendations.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center py-4 text-base-content/60 text-sm">æš«ç„¡æ¨è–¦ï¼Œå¤šå»å¹¾å®¶åº—è©¦è©¦ï¼</div>';
            return;
        }

        container.innerHTML = '';
        // Show top 4 recommendations to avoid clutter
        recommendations.slice(0, 4).forEach(shop => {
            // const status = statusMap[shop.id] || 'none';
            const isHot = (shop.popularity || 0) >= 800;

            const card = document.createElement('div');
            card.className = `card bg-base-100 shadow-sm hover:shadow-md transition-shadow shop-card cursor-pointer border border-primary/20`;

            // Category icons
            let visualIcon = 'ğŸ‡¹ğŸ‡¼';
            if (shop.category === 'ç¾é£Ÿ') visualIcon = 'ğŸœ';
            else if (shop.category === 'å’–å•¡') visualIcon = 'â˜•';
            else if (shop.category === 'ç”œé»') visualIcon = 'ğŸ°';
            else if (shop.category === 'å†°å“') visualIcon = 'ğŸ§';
            else if (shop.category === 'é£²æ–™') visualIcon = 'ğŸ¥¤';
            else if (shop.category === 'é…’å§') visualIcon = 'ğŸº';
            else if (shop.category === 'æ™¯é»') visualIcon = 'â›©ï¸';
            else if (shop.category === 'æ›¸åº—') visualIcon = 'ğŸ“š';
            else if (shop.category === 'è—æ–‡') visualIcon = 'ğŸ¨';
            else if (shop.category === 'ç”Ÿæ´»') visualIcon = 'ğŸ ';
            else if (shop.category === 'ä½å®¿') visualIcon = 'ğŸ¨';
            else if (shop.category === 'å¯µç‰©') visualIcon = 'ğŸ¾';
            else if (shop.category === 'ç¾å®¹') visualIcon = 'ğŸ’‡';
            else if (shop.category === 'è³¼ç‰©') visualIcon = 'ğŸ›ï¸';
            else if (shop.category === 'é†«ç™‚') visualIcon = 'ğŸ¥';
            else if (shop.category === 'é‹å‹•') visualIcon = 'ğŸ’ª';

            const similarToHtml = (shop.similarTo && shop.similarTo.length > 0)
                ? `<div class="text-xs text-primary mt-1">
                    ğŸ”— å› ç‚ºä½ å»éï¼š${shop.similarTo.slice(0, 2).map(s => s.visitedName).join('ã€')}
                   </div>`
                : '';

            card.innerHTML = `
                <div class="card-body p-4 relative">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">${visualIcon}</span>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-base leading-tight">
                                ${shop.name}
                                ${isHot ? '<span class="text-warning text-sm">ğŸ”¥</span>' : ''}
                            </h3>
                            <span class="text-xs text-base-content/50">${shop.category}</span>
                        </div>
                    </div>
                    ${similarToHtml}
                    <div class="card-actions justify-end items-center mt-2 pt-2 border-t border-base-200">
                         <button class="btn btn-xs btn-primary btn-outline"
                                onclick="panToShop('${shop.lat}', '${shop.lng}', '${shop.id}')">
                            åœ¨åœ°åœ–ä¸ŠæŸ¥çœ‹
                        </button>
                    </div>
                </div>
            `;
            // Attach click event for panning (and switching to passport tab)
            card.addEventListener('click', (e) => {
                const target = e.target as HTMLElement;
                if (target.closest('button') || target.closest('a')) return;
                window.panToShop(shop.lat, shop.lng, shop.id);
            });

            container.appendChild(card);
        });
    }

    function getRankTitle(visitedCount: number, totalCount: number) {
        if (totalCount === 0) return { title: 'æ–°æ‰‹ä¸Šè·¯', badgeClass: 'badge-warning' };
        
        const percent = Math.round((visitedCount / totalCount) * 100);
        
        if (percent === 100) return { title: 'åˆ¶éœ¸å…¨å°ï¼', badgeClass: 'badge-success' };
        if (percent > 80) return { title: 'å°ç£å®ˆè­·ç¥', badgeClass: 'badge-secondary' };
        if (percent > 50) return { title: 'å°æ´¾ä¸­å …', badgeClass: 'badge-primary' };
        if (percent > 20) return { title: 'ç†±å¿ƒåƒèˆ‡è€…', badgeClass: 'badge-info' };
        
        return { title: 'æ–°æ‰‹ä¸Šè·¯', badgeClass: 'badge-warning' };
    }

    function getFilteredShops(filterType: string, shops: LocalShop[], _visitedIds: string[], bounds: MapBounds | null = null, center: [number, number] | null = null, locationFilter: string = 'all', searchQuery: string = ''): LocalShop[] {
        let result: LocalShop[] = [];

        // Special handling for Recommendation
        if (filterType === 'recommend') {
             // Use statusMap global variable
             const places = getRecommendations(shops as ProcessedPlace[], statusMap);
             // Map returns (LocalShop | null)[]
             const mapped: (LocalShop | null)[] = places.map((s): LocalShop | null => {
                  const rec = s as RecommendedPlace;
                  const existing = shops.find(shop => shop.place_id === s.place_id);
                  if (!existing) return null;
                  return {
                     ...existing,
                     cfScore: rec.cfScore,
                     similarTo: rec.similarTo
                  };
             });
             result = mapped.filter((s): s is LocalShop => s !== null);
             
             // Recommendation should probably still respect Dislike filter? 
             // Ideally yes, but usually recommendations exclude visited/others.
             // Let's filter out dislikes just in case.
             result = result.filter(shop => {
                const status = (statusMap[shop.id] as ShopStatus | undefined) || 'none';
                return status !== 'dislike';
             });
        } 
        else if (filterType === 'visited') {
            result = shops.filter(shop => {
                const status = statusMap[shop.id];
                return status === 'visited' || status === 'like' || status === 'dislike';
            });
        }
        else {
            // General Filtering
            result = [...shops];

            // 1. Status Visibility Filter (Settings)
            result = result.filter(shop => {
                const status = (statusMap[shop.id] as ShopStatus | undefined) || 'none';
                // Always exclude dislike if hidden, OR if it's explicitly strictly filtered?
                // Actually the requirement is: "Show me X".
                // If the user UNCHECKS 'dislike', then dislikes are hidden.
                // If the user CHECKS 'dislike', they are SHOWN.
                return visibleStatuses.has(status);
            });
        }

        // 2. Category Filter (Multi-select)
        if (filterType === 'all') {
            // Filter by selectedCategories if in 'all' mode.
            // Note: selectedCategories is initialized to all categories in renderFilters.
            // If empty, it means user deselected all, so result should be empty.
            result = result.filter(shop => selectedCategories.has(shop.category));
        }
        
        // 3. Location Filter
        if (locationFilter !== 'all') {
            result = result.filter(shop => shop.city === locationFilter || shop.county === locationFilter);
        }

        // 4. Map Bounds Filter
        if (bounds) {
            result = result.filter(shop => {
                const lat = typeof shop.lat === 'string' ? parseFloat(shop.lat) : shop.lat;
                const lng = typeof shop.lng === 'string' ? parseFloat(shop.lng) : shop.lng;
                return lat >= bounds.south &&
                       lat <= bounds.north &&
                       lng >= bounds.west &&
                       lng <= bounds.east;
            });
        }
        
        // 5. Search Query
        if (searchQuery) {
            const q = searchQuery.toLowerCase();
            result = result.filter(shop => 
                shop.name.toLowerCase().includes(q) || 
                (shop.description || '').toLowerCase().includes(q) ||
                shop.category.toLowerCase().includes(q)
            );
        }

        // 6. Sorting
        // Sort by distance if map center is available
        if (center) {
            result.sort((a, b) => {
                const aLat = typeof a.lat === 'string' ? parseFloat(a.lat) : a.lat;
                const aLng = typeof a.lng === 'string' ? parseFloat(a.lng) : a.lng;
                const bLat = typeof b.lat === 'string' ? parseFloat(b.lat) : b.lat;
                const bLng = typeof b.lng === 'string' ? parseFloat(b.lng) : b.lng;
                
                const distA = Math.pow(aLat - center[0], 2) + Math.pow(aLng - center[1], 2);
                const distB = Math.pow(bLat - center[0], 2) + Math.pow(bLng - center[1], 2);
                return distA - distB;
            });
        }

        return result;
    }


    function initMap() {
        if (mapRenderer) return;
        mapRenderer = new MapRenderer('map');
        mapRenderer.init([23.97565, 120.9738819], 7);
        // Initialize bounds immediately
        currentBounds = mapRenderer.getBounds();

        // Ensure proper sizing after init
        setTimeout(() => mapRenderer?.invalidateSize(), 100);

        mapRenderer.onMoveEnd((bounds) => {
            currentBounds = bounds;
            renderShops();
            updateMapMarkers();
        });

        mapRenderer.onShopFocus((id) => {
            selectedShopId = id;
            renderShops();
        });

        updateMapMarkers();
    }

    function updateMapMarkers() {
        if (!mapRenderer) return;
        
        // Pass null for bounds to keep all markers visible on the map
        const filtered = getFilteredShops(currentFilter, allShops, visitedShops, null, null, currentLocationFilter, currentSearchQuery);
        // Pass statusMap to updateMarkers
        mapRenderer.updateMarkers(filtered, statusMap);
    }

    window.updateUserName = function() {
        const newName = prompt('è«‹è¼¸å…¥ä½ çš„æ–°æš±ç¨±ï¼š', userName);
        if (newName && newName.trim() !== '') {
            userName = newName.trim();
            saveUserName(userName);
        }
    }

    window.exportData = function() {
        const data = JSON.stringify(statusMap);
        prompt("è«‹è¤‡è£½ä»¥ä¸‹ä»£ç¢¼ï¼Œåœ¨å¦ä¸€æ”¯æ‰‹æ©ŸåŒ¯å…¥ï¼š", data);
    }

    window.importData = function() {
        const data = prompt("è«‹è²¼ä¸ŠåŒ¯å‡ºä»£ç¢¼ï¼š");
        if (data) {
            try {
                const parsed = JSON.parse(data);
                if(Array.isArray(parsed)) {
                    // Legacy visited list migration
                    parsed.forEach(id => {
                        if (typeof id === 'string') setShopStatus(id, 'visited');
                    });
                    alert('åŒ¯å…¥æˆåŠŸ (å·²å°‡èˆŠç‰ˆè³‡æ–™è½‰æ›ç‚ºæ–°ç‰ˆ)');
                    location.reload();
                } else if (typeof parsed === 'object' && parsed !== null) {
                    // New status map
                    Object.entries(parsed).forEach(([id, status]) => {
                         if (['want', 'visited', 'like', 'dislike'].includes(status as string)) {
                             setShopStatus(id, status as ShopStatus);
                         }
                    });
                    alert('åŒ¯å…¥æˆåŠŸ');
                    location.reload();
                } else {
                    alert('æ ¼å¼éŒ¯èª¤');
                }
            } catch (e) {
                console.error(e);
                alert('ä»£ç¢¼ç„¡æ•ˆ');
            }
        }
    }

    window.resetData = function() {
        if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿé€™ç„¡æ³•å¾©åŸå–”ï¼')) {
            resetAllData();
            location.reload();
        }
    }

    window.locateUser = function() {
        if (!navigator.geolocation) {
            alert('ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½åŠŸèƒ½');
            return;
        }

        const btn = document.querySelector('button[onclick="locateUser()"]');
        if(btn) btn.classList.add('loading');

        navigator.geolocation.getCurrentPosition(
            (position) => {
                if(btn) btn.classList.remove('loading');
                const { latitude, longitude } = position.coords;
                
                if (mapRenderer) {
                    mapRenderer.setView([latitude, longitude], 15);
                    mapRenderer.addCurrentLocationMarker(latitude, longitude);
                }
            },
            (error) => {
                if(btn) btn.classList.remove('loading');
                console.error(error);
                let msg = 'ç„¡æ³•å–å¾—ä½ çš„ä½ç½®';
                if (error.code === 1) msg = 'è«‹å…è¨±ç€è¦½å™¨å­˜å–ä½ çš„ä½ç½®';
                else if (error.code === 2) msg = 'ç„¡æ³•åµæ¸¬åˆ°ä½ç½®';
                else if (error.code === 3) msg = 'å®šä½é€¾æ™‚';
                alert(msg);
            },
            {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            }
        );
    }
    window.renderShops = renderShops;
    window.updateMapMarkers = updateMapMarkers;
</script>

</body>
</html>
