---
import '../styles/global.css';
---
<!DOCTYPE html>
<html lang="zh-TW" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å„ªè³ªåº—å®¶</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script is:inline src="/byw-mit/papaparse.min.js"></script>
    <script is:inline src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        /* Map needs explicit height */
        #map {
            height: 280px;
            z-index: 1;
        }
        /* Stamp for visited cards */
        .stamp-mark {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-12deg);
            z-index: 10;
        }
        .shop-card.visited .stamp-mark { display: block; }
        .shop-card.visited { opacity: 0.7; }
        .shop-card.visited:hover { opacity: 0.9; }
    </style>
</head>
<body class="bg-base-200 min-h-screen">

<!-- Navbar -->
<div class="navbar bg-base-100 sticky top-0 z-50 shadow-sm">
    <div class="navbar-center flex-1 justify-center">
        <span class="text-xl font-bold">ğŸ‡¹ğŸ‡¼ å°æ´¾ç”Ÿæ´»åœˆãƒ»é»äº®å°ç£</span>
    </div>
</div>

<!-- Progress Section -->
<div class="max-w-4xl mx-auto p-4">
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-4">
            <div class="flex justify-between items-center text-sm">
                <span id="progress-text" class="font-medium">è¸©é»é€²åº¦ï¼š0 / 0</span>
                <span id="level-text" class="badge badge-warning">æ–°æ‰‹ä¸Šè·¯</span>
            </div>
            <progress id="progress-fill" class="progress progress-success w-full" value="0" max="100"></progress>
        </div>
    </div>
</div>

<!-- Tabs -->
<div class="max-w-4xl mx-auto px-4">
    <div role="tablist" class="tabs tabs-bordered">
        <a role="tab" class="tab tab-active" id="tab-passport" onclick="switchTab('passport')">è¸©é»è­·ç…§</a>
        <a role="tab" class="tab" id="tab-leaderboard" onclick="switchTab('leaderboard')">æ’è¡Œæ¦œ</a>
    </div>
</div>

<!-- Passport View -->
<div id="passport-view" class="max-w-4xl mx-auto p-4">
    <!-- Filter Buttons -->
    <div id="filter-container" class="flex gap-2 overflow-x-auto pb-4 scrollbar-hide">
    </div>

    <!-- Map -->
    <div id="map" class="rounded-lg shadow-sm mb-6"></div>

    <!-- Loading -->
    <div id="loading" class="text-center py-8 text-base-content/60">
        <span class="loading loading-spinner loading-md"></span>
        <p class="mt-2">è®€å–åº—å®¶è³‡æ–™ä¸­...</p>
    </div>

    <!-- Shop Grid -->
    <div id="shop-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    </div>
</div>

<!-- Leaderboard View -->
<div id="leaderboard-view" class="hidden max-w-4xl mx-auto p-4">
    <div class="text-center py-4">
        <h3 class="text-xl font-bold">ğŸ† å°ç£åˆ¶éœ¸æ’è¡Œæ¦œ</h3>
        <p id="user-rank-info" class="text-base-content/60 mt-2">è¼‰å…¥ä¸­...</p>
    </div>

    <h4 class="font-bold mt-6 mb-3">ğŸ‘¤ ç©å®¶æ’è¡Œæ¦œ</h4>
    <div class="overflow-x-auto">
        <table class="table table-zebra bg-base-100 rounded-lg">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>åç¨±</th>
                    <th>è¸©é»æ•¸</th>
                    <th>ç¨±è™Ÿ</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
            </tbody>
        </table>
    </div>

    <h4 class="font-bold mt-8 mb-3">ğŸ”¥ ç†±é–€åº—å®¶æ’è¡Œæ¦œ</h4>
    <div class="overflow-x-auto">
        <table class="table table-zebra bg-base-100 rounded-lg">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>åº—å®¶åç¨±</th>
                    <th>é¡åˆ¥</th>
                    <th>äººæ°£æŒ‡æ•¸</th>
                </tr>
            </thead>
            <tbody id="shop-leaderboard-body">
            </tbody>
        </table>
    </div>

    <h4 class="font-bold mt-8 mb-3">ğŸ‘€ å…¨å°åº—å®¶æ¡é»å¤§æ¯”æ‹¼</h4>
    <div class="overflow-x-auto">
        <table class="table table-zebra bg-base-100 rounded-lg">
            <thead>
                <tr>
                    <th>åº—å®¶</th>
                    <th>é¡åˆ¥</th>
                    <th>æˆ‘çš„ç‹€æ…‹</th>
                    <th>èª°ä¹Ÿå»é</th>
                </tr>
            </thead>
            <tbody id="comparison-body">
            </tbody>
        </table>
    </div>

    <div class="text-center mt-6">
        <button class="btn btn-outline btn-sm" onclick="updateUserName()">ä¿®æ”¹æˆ‘çš„æš±ç¨±</button>
    </div>
</div>

<!-- Footer -->
<footer class="footer footer-center p-6 bg-base-100 text-base-content/60 mt-8 border-t border-base-300">
    <div>
        <p>è³‡æ–™ä¾†æºï¼šç¤¾ç¾¤å…±ç·¨ | ç³»çµ±è£½ä½œï¼šGemini å”åŠ©é–‹ç™¼</p>
        <div class="flex gap-4 mt-2">
            <button class="link link-hover" onclick="exportData()">åŒ¯å‡ºç´€éŒ„</button>
            <button class="link link-hover" onclick="importData()">åŒ¯å…¥ç´€éŒ„</button>
            <button class="link link-hover text-error" onclick="resetData()">é‡ç½®</button>
        </div>
    </div>
</footer>

<script is:inline>
    const CSV_URL = '/byw-mit/mock_shops.csv';
    const LEADERBOARD_URL = '/byw-mit/mock_leaderboard.csv';

    let allShops = [];
    let visitedShops = JSON.parse(localStorage.getItem('visited_shops')) || [];
    let favoriteShops = JSON.parse(localStorage.getItem('favorite_shops')) || [];
    let userName = localStorage.getItem('user_name') || 'å°ç£å›¡ä»”';
    let currentFilter = 'recommend';
    let map = null;
    let markers = [];
    let leaderboardData = [];

    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('user_name')) {
            localStorage.setItem('user_name', userName);
        }

        if (typeof Papa === 'undefined') {
            document.getElementById('loading').innerHTML = '<div class="alert alert-error"><span>âŒ ç„¡æ³•è¼‰å…¥ PapaParse</span></div>';
            return;
        }

        fetchData();
        fetchLeaderboard();
    });

    function fetchData() {
        Papa.parse(CSV_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (!results.data || results.data.length === 0) {
                    document.getElementById('loading').innerHTML = '<div class="alert alert-warning"><span>âš ï¸ è¼‰å…¥æˆåŠŸä½†æ²’æœ‰è³‡æ–™</span></div>';
                    return;
                }

                allShops = results.data.filter(item => item.id && item.name);

                if (allShops.length === 0) {
                    document.getElementById('loading').innerHTML = '<div class="alert alert-warning"><span>âš ï¸ è³‡æ–™æ ¼å¼ä¸ç¬¦</span></div>';
                    return;
                }

                document.getElementById('loading').style.display = 'none';
                initMap();
                renderFilters();
                renderShops();
                updateProgress();
            },
            error: function(err) {
                document.getElementById('loading').innerHTML = `<div class="alert alert-error"><span>âŒ è¼‰å…¥å¤±æ•—: ${err.message || 'æœªçŸ¥éŒ¯èª¤'}</span></div>`;
            }
        });
    }

    function renderFilters() {
        const categories = ['å…¨éƒ¨', 'æ¨è–¦', 'ç†±é–€', ...new Set(allShops.map(s => s.category))];
        const container = document.getElementById('filter-container');

        let html = '';
        categories.forEach(cat => {
            let label = cat;
            let val = cat;

            if (cat === 'å…¨éƒ¨') {
                val = 'all';
            } else if (cat === 'æ¨è–¦') {
                val = 'recommend';
                label = 'âœ¨ æ¨è–¦çµ¦ä½ ';
            } else if (cat === 'ç†±é–€') {
                val = 'hot';
                label = 'ğŸ”¥ ç†±é–€';
            }

            html += `<button class="btn btn-sm ${val === currentFilter ? 'btn-primary' : 'btn-ghost'}"
                             onclick="setFilter('${val}', this)">${label}</button>`;
        });
        container.innerHTML = html;
    }

    window.setFilter = function(category, btnElement) {
        currentFilter = category;
        document.querySelectorAll('#filter-container .btn').forEach(b => {
            b.classList.remove('btn-primary');
            b.classList.add('btn-ghost');
        });
        btnElement.classList.remove('btn-ghost');
        btnElement.classList.add('btn-primary');
        renderShops();
        updateMapMarkers();
    }

    // Build shop visitor sets (cached for performance)
    function getShopVisitorMap() {
        const shopVisitorMap = new Map(); // shop_id -> Set of visitors
        allShops.forEach(shop => {
            const visitors = shop.recent_visitors
                ? new Set(shop.recent_visitors.split(',').map(v => v.trim()).filter(v => v))
                : new Set();
            shopVisitorMap.set(shop.id, visitors);
        });
        return shopVisitorMap;
    }

    // Item-to-Item CF: calculate similarity between two shops based on shared visitors
    function calcItemSimilarity(visitorsA, visitorsB) {
        if (visitorsA.size === 0 || visitorsB.size === 0) return 0;
        const intersection = [...visitorsA].filter(v => visitorsB.has(v)).length;
        const union = new Set([...visitorsA, ...visitorsB]).size;
        return union > 0 ? intersection / union : 0;
    }

    // User-based CF: find similar users
    function getUserBasedScores(userShopMap, myShopsSet) {
        const shopScores = new Map();

        userShopMap.forEach((userShops) => {
            const intersection = [...myShopsSet].filter(id => userShops.has(id)).length;
            const union = new Set([...myShopsSet, ...userShops]).size;
            const similarity = union > 0 ? intersection / union : 0;

            if (similarity > 0) {
                userShops.forEach(shopId => {
                    if (!myShopsSet.has(shopId)) {
                        const current = shopScores.get(shopId) || 0;
                        shopScores.set(shopId, current + similarity);
                    }
                });
            }
        });

        return shopScores;
    }

    // Item-to-Item CF: find similar shops to what user visited
    // Returns { scores: Map, similarTo: Map } where similarTo maps shopId -> [{ visitedId, visitedName, similarity }]
    function getItemBasedScores(shopVisitorMap, myShopsSet) {
        const shopScores = new Map();
        const similarTo = new Map(); // Track which visited shops contributed

        // For each shop user visited, find similar unvisited shops
        myShopsSet.forEach(visitedId => {
            const visitedVisitors = shopVisitorMap.get(visitedId) || new Set();
            const visitedShop = allShops.find(s => s.id === visitedId);

            allShops.forEach(shop => {
                if (myShopsSet.has(shop.id)) return; // Skip already visited

                const shopVisitors = shopVisitorMap.get(shop.id) || new Set();
                const similarity = calcItemSimilarity(visitedVisitors, shopVisitors);

                if (similarity > 0) {
                    const current = shopScores.get(shop.id) || 0;
                    shopScores.set(shop.id, current + similarity);

                    // Track similar shops
                    if (!similarTo.has(shop.id)) {
                        similarTo.set(shop.id, []);
                    }
                    similarTo.get(shop.id).push({
                        visitedId,
                        visitedName: visitedShop?.name || visitedId,
                        similarity
                    });
                }
            });
        });

        // Sort similarTo by similarity for each shop
        similarTo.forEach((items) => {
            items.sort((a, b) => b.similarity - a.similarity);
        });

        return { scores: shopScores, similarTo };
    }

    // Hybrid Collaborative Filtering: combine user-based and item-based
    function getRecommendations() {
        if (visitedShops.length === 0) {
            // Cold start: return popular shops
            return allShops
                .filter(s => !visitedShops.includes(s.id))
                .sort((a, b) => (parseInt(b.popularity) || 0) - (parseInt(a.popularity) || 0))
                .slice(0, 10);
        }

        const myShopsSet = new Set(visitedShops);
        const shopVisitorMap = getShopVisitorMap();

        // Build user-shop matrix
        const userShopMap = new Map();
        allShops.forEach(shop => {
            const visitors = shop.recent_visitors ? shop.recent_visitors.split(',').map(v => v.trim()).filter(v => v) : [];
            visitors.forEach(user => {
                if (!userShopMap.has(user)) {
                    userShopMap.set(user, new Set());
                }
                userShopMap.get(user).add(shop.id);
            });
        });

        // Get scores from both methods
        const userBasedScores = getUserBasedScores(userShopMap, myShopsSet);
        const { scores: itemBasedScores, similarTo } = getItemBasedScores(shopVisitorMap, myShopsSet);

        // Combine scores (weighted: 0.5 user-based + 0.5 item-based)
        const combinedScores = new Map();
        const allShopIds = new Set([...userBasedScores.keys(), ...itemBasedScores.keys()]);

        allShopIds.forEach(shopId => {
            const userScore = userBasedScores.get(shopId) || 0;
            const itemScore = itemBasedScores.get(shopId) || 0;
            combinedScores.set(shopId, 0.5 * userScore + 0.5 * itemScore);
        });

        // Sort and return top recommendations
        const recommended = [...combinedScores.entries()]
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10)
            .map(([shopId, score]) => {
                const shop = allShops.find(s => s.id === shopId);
                const similar = similarTo.get(shopId) || [];
                return { ...shop, cfScore: score, similarTo: similar };
            })
            .filter(s => s.id);

        // If not enough recommendations, fill with popular unvisited shops
        if (recommended.length < 5) {
            const popular = allShops
                .filter(s => !visitedShops.includes(s.id) && !recommended.find(r => r.id === s.id))
                .sort((a, b) => (parseInt(b.popularity) || 0) - (parseInt(a.popularity) || 0))
                .slice(0, 5 - recommended.length);
            recommended.push(...popular);
        }

        return recommended;
    }

    function renderShops() {
        const container = document.getElementById('shop-list');
        container.innerHTML = '';

        let filtered = [];
        let isRecommend = false;

        if (currentFilter === 'all') {
            filtered = allShops;
        } else if (currentFilter === 'recommend') {
            filtered = getRecommendations();
            isRecommend = true;
        } else if (currentFilter === 'hot') {
            filtered = allShops.filter(s => (parseInt(s.popularity) || 0) >= 800);
            filtered.sort((a, b) => (parseInt(b.popularity) || 0) - (parseInt(a.popularity) || 0));
        } else {
            filtered = allShops.filter(s => s.category === currentFilter);
        }

        if(filtered.length === 0) {
            container.innerHTML = '<div class="col-span-full text-center py-8 text-base-content/60">æ²’æœ‰ç¬¦åˆçš„åº—å®¶</div>';
            return;
        }

        // Show recommendation explanation
        if (isRecommend) {
            const explainDiv = document.createElement('div');
            explainDiv.className = 'col-span-full mb-4 p-3 bg-primary/10 rounded-lg text-sm text-center';
            explainDiv.innerHTML = visitedShops.length > 0
                ? 'ğŸ¤ æ ¹æ“šç›¸ä¼¼ç©å®¶ + ç›¸ä¼¼åº—å®¶æ¨è–¦ï¼ˆHybrid CFï¼‰'
                : 'ğŸŒŸ ä½ é‚„æ²’è¸©é»ï¼Œå…ˆæ¨è–¦ç†±é–€åº—å®¶çµ¦ä½ ';
            container.appendChild(explainDiv);
        }

        filtered.forEach(shop => {
            const isVisited = visitedShops.includes(shop.id);
            const isFavorite = favoriteShops.includes(shop.id);
            const popularity = parseInt(shop.popularity) || 0;
            const isHot = popularity >= 800;

            const card = document.createElement('div');
            card.className = `card bg-base-100 shadow-sm hover:shadow-md transition-shadow shop-card ${isVisited ? 'visited' : ''}`;

            // Category colors using DaisyUI color classes
            let bgClass = 'bg-base-200';
            let visualIcon = 'ğŸ‡¹ğŸ‡¼';

            if (shop.category === 'ç¾é£Ÿ') {
                visualIcon = 'ğŸœ';
                bgClass = 'bg-warning/20';
            } else if (shop.category === 'å’–å•¡') {
                visualIcon = 'â˜•';
                bgClass = 'bg-secondary/20';
            } else if (shop.category === 'æ™¯é»') {
                visualIcon = 'â›©ï¸';
                bgClass = 'bg-success/20';
            } else if (shop.category === 'æ›¸åº—') {
                visualIcon = 'ğŸ“š';
                bgClass = 'bg-accent/20';
            } else if (shop.category === 'ç”Ÿæ´»') {
                visualIcon = 'ğŸ ';
                bgClass = 'bg-info/20';
            }

            const visitors = shop.recent_visitors ? shop.recent_visitors.split(',').map(v => v.trim()).filter(v => v) : [];
            const visitorsHtml = visitors.length > 0
                ? `<div class="flex flex-wrap gap-1 mt-2">
                    <span class="text-xs text-base-content/50">å»éï¼š</span>
                    ${visitors.slice(0, 3).map(v => `<span class="badge badge-ghost badge-xs">${v}</span>`).join('')}
                    ${visitors.length > 3 ? `<span class="text-xs text-base-content/50">+${visitors.length - 3}</span>` : ''}
                   </div>`
                : '';

            // Item-to-Item: show which visited shops are similar
            // Social Counts
            const visitCount = visitors.length;
            const collectCount = parseInt(shop.popularity) || 0;
            
            const statsHtml = `
                <div class="flex gap-3 text-xs text-base-content/60 mt-2 mb-1">
                    <span class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                        </svg>
                        ${collectCount} äººæ”¶è—
                    </span>
                    <span class="flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                        ${visitCount} äººå»é
                    </span>
                </div>
            `;

            const similarToHtml = (isRecommend && shop.similarTo && shop.similarTo.length > 0)
                ? `<div class="text-xs text-primary mt-1">
                    ğŸ”— å› ç‚ºä½ å»éï¼š${shop.similarTo.slice(0, 2).map(s => s.visitedName).join('ã€')}
                   </div>`
                : '';

            const showRecommendBadge = isRecommend && shop.cfScore;

            card.innerHTML = `
                <figure class="${bgClass} h-28 flex items-center justify-center relative">
                    <span class="text-5xl">${visualIcon}</span>
                    ${showRecommendBadge ? '<div class="badge badge-primary absolute top-2 right-2 text-xs">âœ¨ æ¨è–¦</div>' : ''}
                    ${isHot && !showRecommendBadge ? '<div class="badge badge-error absolute top-2 right-2 text-xs">HOT</div>' : ''}
                </figure>
                <div class="card-body p-4 relative">
                    <div class="stamp-mark">
                        <div class="badge badge-success badge-lg">âœ“ COMPLETED</div>
                    </div>
                    <h3 class="card-title text-base">
                        ${shop.name}
                        ${isHot ? '<span class="text-warning">ğŸ”¥</span>' : ''}
                    </h3>
                    <div class="badge badge-outline badge-sm">${shop.category}</div>
                    <p class="text-sm text-base-content/70 line-clamp-2">${shop.description || 'æš«ç„¡ä»‹ç´¹'}</p>
                    ${statsHtml}
                    ${similarToHtml}
                    ${visitorsHtml}
                    <div class="card-actions justify-between items-center mt-auto pt-3 border-t border-base-200">
                        <div class="flex gap-2">
                            <a href="${shop.map_url}" target="_blank" class="btn btn-sm btn-ghost btn-circle" title="åœ°åœ–">ğŸ“</a>
                            <button class="btn btn-sm btn-circle ${isFavorite ? 'btn-error text-white' : 'btn-ghost text-error'}"
                                    onclick="toggleFavorite('${shop.id}', this)" title="æ”¶è—">
                                ${isFavorite ? 'â¤' : 'â™¡'}
                            </button>
                        </div>
                        <button class="btn btn-sm ${isVisited ? 'btn-success' : 'btn-outline'}"
                                onclick="toggleVisit('${shop.id}')">
                            ${isVisited ? 'å·²æ”»ç•¥' : 'æ”»ç•¥'}
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    window.toggleFavorite = function(id, btn) {
        if (favoriteShops.includes(id)) {
            favoriteShops = favoriteShops.filter(sid => sid !== id);
        } else {
            favoriteShops.push(id);
        }
        localStorage.setItem('favorite_shops', JSON.stringify(favoriteShops));
        
        // Optimistic UI update instead of full re-render for better UX
        const isFav = favoriteShops.includes(id);
        btn.classList.toggle('btn-error', isFav);
        btn.classList.toggle('text-white', isFav);
        btn.classList.toggle('btn-ghost', !isFav);
        btn.innerText = isFav ? 'â¤' : 'â™¡';
    }

    window.toggleVisit = function(id) {
        if (visitedShops.includes(id)) {
            if(!confirm('ç¢ºå®šè¦å–æ¶ˆé€™å€‹è¸©é»ç´€éŒ„å—ï¼Ÿ')) return;
            visitedShops = visitedShops.filter(sid => sid !== id);
        } else {
            visitedShops.push(id);
        }
        localStorage.setItem('visited_shops', JSON.stringify(visitedShops));
        renderShops();
        updateProgress();
    }

    function updateProgress() {
        const total = allShops.length;
        const current = visitedShops.length;
        const percent = total === 0 ? 0 : Math.round((current / total) * 100);

        document.getElementById('progress-text').innerText = `è¸©é»é€²åº¦ï¼š${current} / ${total}`;
        document.getElementById('progress-fill').value = percent;

        let title = 'æ–°æ‰‹ä¸Šè·¯';
        let badgeClass = 'badge-warning';
        if (percent > 20) { title = 'ç†±å¿ƒåƒèˆ‡è€…'; badgeClass = 'badge-info'; }
        if (percent > 50) { title = 'å°æ´¾ä¸­å …'; badgeClass = 'badge-primary'; }
        if (percent > 80) { title = 'å°ç£å®ˆè­·ç¥'; badgeClass = 'badge-secondary'; }
        if (percent === 100) { title = 'åˆ¶éœ¸å…¨å°ï¼'; badgeClass = 'badge-success'; }

        const levelEl = document.getElementById('level-text');
        levelEl.innerText = title;
        levelEl.className = `badge ${badgeClass}`;
    }

    function initMap() {
        if (map) return;
        map = L.map('map').setView([23.97565, 120.9738819], 7);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        updateMapMarkers();
    }

    function updateMapMarkers() {
        if (!map) return;

        markers.forEach(m => map.removeLayer(m));
        markers = [];

        let filtered;
        if (currentFilter === 'all') {
            filtered = allShops;
        } else if (currentFilter === 'recommend') {
            filtered = getRecommendations();
        } else if (currentFilter === 'hot') {
            filtered = allShops.filter(s => (parseInt(s.popularity) || 0) >= 800);
        } else {
            filtered = allShops.filter(s => s.category === currentFilter);
        }

        filtered.forEach(shop => {
            if (shop.lat && shop.lng) {
                const isVisited = visitedShops.includes(shop.id);

                const marker = L.marker([parseFloat(shop.lat), parseFloat(shop.lng)])
                    .addTo(map)
                    .bindPopup(`
                        <b>${shop.name}</b><br>
                        ${shop.category}<br>
                        ${isVisited ? 'âœ… å·²è¸©é»' : 'â¬œ æœªè¸©é»'}
                    `);
                markers.push(marker);
            }
        });
    }

    function fetchLeaderboard() {
        Papa.parse(LEADERBOARD_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.data) {
                    leaderboardData = results.data;
                    renderLeaderboard();
                }
            }
        });
    }

    function renderLeaderboard() {
        const tbody = document.getElementById('leaderboard-body');
        tbody.innerHTML = '';

        let currentUser = {
            rank: 0,
            name: userName + ' (æˆ‘)',
            visited_count: visitedShops.length,
            title: document.getElementById('level-text').innerText,
            isUser: true
        };

        let combined = leaderboardData.map(d => ({
            ...d,
            visited_count: parseInt(d.visited_count) || 0
        }));

        combined.push(currentUser);
        combined.sort((a, b) => b.visited_count - a.visited_count);

        let userRank = 0;
        combined.forEach((item, index) => {
            const rank = index + 1;
            const isMe = item.isUser === true;
            if (isMe) userRank = rank;

            const tr = document.createElement('tr');
            if (isMe) tr.className = 'bg-primary/10';

            let rankBadge = `#${rank}`;
            if (rank === 1) rankBadge = 'ğŸ¥‡';
            if (rank === 2) rankBadge = 'ğŸ¥ˆ';
            if (rank === 3) rankBadge = 'ğŸ¥‰';

            tr.innerHTML = `
                <td class="font-bold">${rankBadge}</td>
                <td>${item.name}</td>
                <td>${item.visited_count}</td>
                <td><span class="badge badge-sm">${item.title}</span></td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('user-rank-info').innerText = `ä½ çš„ç›®å‰æ’åï¼šç¬¬ ${userRank} å`;

        // Shop leaderboard
        const shopTbody = document.getElementById('shop-leaderboard-body');
        shopTbody.innerHTML = '';

        let sortedShops = [...allShops].sort((a, b) => (parseInt(b.popularity) || 0) - (parseInt(a.popularity) || 0));
        let topShops = sortedShops.slice(0, 5);

        topShops.forEach((shop, index) => {
            const rank = index + 1;
            const tr = document.createElement('tr');

            let rankBadge = `#${rank}`;
            if (rank === 1) rankBadge = 'ğŸ¥‡';
            if (rank === 2) rankBadge = 'ğŸ¥ˆ';
            if (rank === 3) rankBadge = 'ğŸ¥‰';

            tr.innerHTML = `
                <td class="font-bold">${rankBadge}</td>
                <td>${shop.name}</td>
                <td><span class="badge badge-outline badge-sm">${shop.category}</span></td>
                <td>ğŸ”¥ ${shop.popularity || 0}</td>
            `;
            shopTbody.appendChild(tr);
        });

        // Comparison table
        const compTbody = document.getElementById('comparison-body');
        compTbody.innerHTML = '';

        allShops.forEach(shop => {
            const isVisited = visitedShops.includes(shop.id);
            const visitors = shop.recent_visitors ? shop.recent_visitors.split(',') : [];

            const tr = document.createElement('tr');
            if (isVisited) tr.className = 'bg-success/10';

            let tagsHtml = visitors.length > 0
                ? visitors.map(v => `<span class="badge badge-ghost badge-sm mr-1">${v.trim()}</span>`).join('')
                : '<span class="text-base-content/40 text-sm">å°šç„¡è³‡æ–™</span>';

            tr.innerHTML = `
                <td>${shop.name}</td>
                <td><span class="badge badge-outline badge-sm">${shop.category}</span></td>
                <td>${isVisited ? '<span class="text-success">âœ… å·²æ”»ç•¥</span>' : '<span class="text-base-content/40">â¬œ æœªæ”»ç•¥</span>'}</td>
                <td>${tagsHtml}</td>
            `;
            compTbody.appendChild(tr);
        });
    }

    window.switchTab = function(tabName) {
        document.getElementById('tab-passport').classList.remove('tab-active');
        document.getElementById('tab-leaderboard').classList.remove('tab-active');

        if (tabName === 'passport') {
            document.getElementById('tab-passport').classList.add('tab-active');
            document.getElementById('passport-view').classList.remove('hidden');
            document.getElementById('leaderboard-view').classList.add('hidden');
            if (map) map.invalidateSize();
        } else {
            document.getElementById('tab-leaderboard').classList.add('tab-active');
            document.getElementById('passport-view').classList.add('hidden');
            document.getElementById('leaderboard-view').classList.remove('hidden');
            renderLeaderboard();
        }
    }

    window.updateUserName = function() {
        const newName = prompt('è«‹è¼¸å…¥ä½ çš„æ–°æš±ç¨±ï¼š', userName);
        if (newName && newName.trim() !== '') {
            userName = newName.trim();
            localStorage.setItem('user_name', userName);
            renderLeaderboard();
        }
    }

    window.exportData = function() {
        const data = localStorage.getItem('visited_shops');
        prompt("è«‹è¤‡è£½ä»¥ä¸‹ä»£ç¢¼ï¼Œåœ¨å¦ä¸€æ”¯æ‰‹æ©ŸåŒ¯å…¥ï¼š", data);
    }

    window.importData = function() {
        const data = prompt("è«‹è²¼ä¸ŠåŒ¯å‡ºä»£ç¢¼ï¼š");
        if (data) {
            try {
                const parsed = JSON.parse(data);
                if(Array.isArray(parsed)) {
                    visitedShops = parsed;
                    localStorage.setItem('visited_shops', JSON.stringify(visitedShops));
                    location.reload();
                } else {
                    alert('æ ¼å¼éŒ¯èª¤');
                }
            } catch (e) {
                alert('ä»£ç¢¼ç„¡æ•ˆ');
            }
        }
    }

    window.resetData = function() {
        if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç´€éŒ„å—ï¼Ÿé€™ç„¡æ³•å¾©åŸå–”ï¼')) {
            localStorage.removeItem('visited_shops');
            location.reload();
        }
    }
</script>

</body>
</html>
